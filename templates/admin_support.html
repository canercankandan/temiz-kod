<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Canlı Destek - Su Arıtma Uzmanı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: white;
            line-height: 1.6;
            color: black;
        }
    </style>
</head>
<body>
<div class="container-fluid my-4" style="background-color: white; color: black; min-height: 100vh;">
    <div class="row">
        <!-- Sessions List -->
        <div class="col-md-4">
            <div class="card" style="background-color: white; border: 1px solid #ddd;">
                <div class="card-header" style="background-color: #f8f9fa; color: black; border-bottom: 1px solid #ddd;">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Aktif Sohbetler
                        <span class="badge bg-dark text-white ms-2" id="sessionCount">{{len .sessions}}</span>
                    </h5>
                    <!-- Arama Kutusu -->
                    <div class="mt-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" id="sessionSearchInput" 
                                   placeholder="Kullanıcı adı ara..." onkeyup="filterSessions()">
                            <button class="btn btn-outline-secondary border-start-0" type="button" onclick="clearSearch()" title="Aramayı Temizle">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto; background-color: white;">
                    <div id="sessionsList">
                        {{if .sessions}}
                            {{range .sessions}}
                            <div class="session-item p-3 border-bottom cursor-pointer" data-session-id="{{.SessionID}}" onclick="loadChat('{{.SessionID}}', '{{.Username}}')" style="background-color: white; color: black;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" style="color: black;">{{.Username}}</h6>
                                        <small style="color: #666;">
                                            <i class="fas fa-clock me-1"></i>
                                            {{.LastMessageAt.Format "15:04"}}
                                        </small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        {{if gt .UnreadCount 0}}
                                        <span class="badge bg-danger me-2">{{.UnreadCount}}</span>
                                        {{end}}
                                        <!-- Video Call Request Buttons -->
                                        <div class="video-call-buttons" id="videoCallButtons-{{.SessionID}}" style="display: none;">
                                            <button class="btn btn-success btn-sm me-1" onclick="acceptVideoCall('{{.SessionID}}', '{{.Username}}')" title="Video Görüşmeyi Kabul Et">
                                                <i class="fas fa-video"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="rejectVideoCall('{{.SessionID}}', '{{.Username}}')" title="Video Görüşmeyi Reddet">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Video Call Request Notification -->
                                <div class="video-call-notification mt-2" id="videoCallNotification-{{.SessionID}}" style="display: none;">
                                    <div class="alert alert-info py-2 mb-0" style="font-size: 12px;">
                                        <i class="fas fa-video me-1"></i>
                                        <strong>{{.Username}}</strong> görüntülü görüşme istiyor
                                    </div>
                                </div>
                            </div>
                            {{end}}
                        {{else}}
                        <div class="p-4 text-center" style="color: #666;">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Henüz aktif sohbet yok</p>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="col-md-8">
            <div class="card" style="background-color: white; border: 1px solid #ddd;">
                <div class="card-header" style="background-color: #f8f9fa; color: black; border-bottom: 1px solid #ddd;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="chatHeader">
                            <i class="fas fa-comment-dots me-2"></i>Sohbet Seçin
                        </h5>
                        <div id="videoCallControls" style="display: none;">
                            <span id="videoCallRequestInfo" class="me-3 text-info">
                                <i class="fas fa-video me-1"></i>
                                <span id="videoCallUsername">Kullanıcı</span> görüntülü görüşme istiyor
                            </span>
                            <button id="acceptVideoCallBtn" class="btn btn-success btn-sm me-2" title="Video Görüşmeyi Kabul Et">
                                <i class="fas fa-video me-1"></i>Kabul Et
                            </button>
                            <button id="rejectVideoCallBtn" class="btn btn-danger btn-sm me-2" title="Video Görüşmeyi Reddet">
                                <i class="fas fa-times me-1"></i>Reddet
                            </button>
                            <button id="endAdminCallBtn" class="btn btn-secondary btn-sm" style="display: none;" title="Görüşmeyi Sonlandır">
                                <i class="fas fa-phone-slash me-1"></i>Sonlandır
                            </button>
                        </div>
                        <div id="adminVideoCallControls" style="display: none;">
                            <button id="startVideoCallBtn" class="btn btn-success btn-sm me-2" title="Müşteriye Video Görüşme Başlat">
                                <i class="fas fa-video me-1"></i>Video Görüşme Başlat
                            </button>
                            <button id="endAdminCallBtn2" class="btn btn-secondary btn-sm" style="display: none;" title="Görüşmeyi Sonlandır">
                                <i class="fas fa-phone-slash me-1"></i>Sonlandır
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0" style="background-color: white;">
                    <!-- Video Call Area - Düzeltilmiş Tasarım -->
                    <div id="adminVideoCallArea" class="video-call-area" style="display: none; height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; border-radius: 0; overflow: hidden; box-shadow: none; margin: 10px; border: none;">
                        <!-- Ana Video (Ziyaretçi/Müşteri) -->
                        <video id="adminRemoteVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; border-radius: 0;"></video>
                        
                        <!-- Küçük Video (Admin) - Sağ Üst Köşe -->
                        <div class="admin-pip-container" style="position: absolute; top: 15px; right: 15px; z-index: 20; border-radius: 0; overflow: hidden; box-shadow: none; transition: all 0.3s ease; cursor: move; border: none;" id="adminPipContainer">
                            <video id="adminLocalVideo" autoplay muted style="width: 200px; height: 150px; object-fit: cover; border: none; border-radius: 0; transform: scaleX(-1);"></video>
                        </div>
                        
                        <!-- Görüşme Durumu -->
                        <div class="call-status-modern" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 15; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 15px; color: white; font-size: 12px; font-weight: 500; border: 1px solid rgba(255,255,255,0.2);">
                            <i class="fas fa-circle text-success me-2" style="font-size: 6px; animation: pulse 2s infinite;"></i>
                            <span id="adminCallStatusText">Görüşme Aktif</span>
                        </div>
                        
                        <!-- Dikey Kontroller (Sol Taraf) -->
                        <div class="admin-vertical-controls" style="position: absolute; top: 50%; left: 15px; transform: translateY(-50%); z-index: 15; display: flex; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); padding: 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 25px rgba(0,0,0,0.4);">
                            
                            <button id="adminToggleVideoBtn" class="btn admin-control-btn" title="Kamerayı Aç/Kapat" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(108,117,125,0.9); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <i class="fas fa-video" style="font-size: 14px; color: white;"></i>
                            </button>
                            <button id="adminSwitchCameraBtn" class="btn admin-control-btn" onclick="adminSwitchCameras()" title="Kamera Değiştir" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(23,162,184,0.9); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <i class="fas fa-sync-alt" style="font-size: 14px; color: white;"></i>
                            </button>
                            <button id="adminEndCallBtn" class="btn admin-control-btn" onclick="endAdminVideoCall()" title="Görüşmeyi Sonlandır" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(220,53,69,0.9); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <i class="fas fa-phone-slash" style="font-size: 14px; color: white;"></i>
                            </button>
                        </div>
                        
                        <!-- Mobil Kontroller (Sol Taraf) -->
                        <div class="admin-mobile-controls" style="position: absolute; top: 50%; left: 15px; transform: translateY(-50%); z-index: 15; display: none; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); padding: 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 25px rgba(0,0,0,0.4);">
                            
                            <button id="adminMobileToggleVideoBtn" class="btn admin-mobile-control" title="Kamerayı Aç/Kapat" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(108,117,125,0.9); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <i class="fas fa-video" style="font-size: 14px; color: white;"></i>
                            </button>
                            <button id="adminMobileSwitchCameraBtn" class="btn admin-mobile-control" onclick="adminSwitchCameras()" title="Kamera Değiştir" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(23,162,184,0.9); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <i class="fas fa-sync-alt" style="font-size: 14px; color: white;"></i>
                            </button>
                            <button id="adminMobileEndCallBtn" class="btn admin-mobile-control" onclick="endAdminVideoCall()" title="Görüşmeyi Sonlandır" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(220,53,69,0.9); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <i class="fas fa-phone-slash" style="font-size: 14px; color: white;"></i>
                            </button>
                        </div>
                        
                        <!-- Kamera Değiştirme Bildirimi -->
                        <div id="adminCameraSwitch" class="camera-switch-notification" style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); z-index: 20; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; color: white; font-size: 12px; font-weight: 500; display: none; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                            <i class="fas fa-sync-alt fa-spin me-2" style="color: #17a2b8;"></i>Kamera değiştiriliyor...
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background: white; color: black;">
                        <div class="text-center" style="color: #666;">
                            <i class="fas fa-arrow-left fa-2x mb-3"></i>
                            <p>Soldan bir sohbet seçin</p>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="chat-input border-top p-3" id="chatInput" style="display: none; background-color: white; border-top: 1px solid #ddd;">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Yanıtınızı yazın..." maxlength="500" style="background-color: white; color: black; border: 1px solid #ddd;">
                            <button class="btn btn-primary" id="sendButton" type="button">
                                <i class="fas fa-paper-plane"></i> Gönder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Override base styles for white background theme */
body {
    background-color: white !important;
    color: black !important;
}

.session-item {
    transition: background-color 0.2s;
    cursor: pointer;
    background-color: white !important;
    color: black !important;
}

.session-item:hover {
    background-color: #f8f9fa !important;
    color: black !important;
}

.session-item.active {
    background-color: #e3f2fd !important;
    border-left: 4px solid #2196F3;
    color: black !important;
}

.chat-messages {
    background: white !important;
    color: black !important;
}

.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user {
    text-align: left;
}

.message.admin {
    text-align: right;
}

.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.message.user .message-bubble {
    background: #f8f9fa;
    color: black;
    border: 1px solid #ddd;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message.admin .message-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 4px;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}

.message.user .message-time {
    text-align: left;
    color: #666;
}

.message.admin .message-time {
    text-align: right;
    color: #007bff;
}

.cursor-pointer {
    cursor: pointer;
}

#messageInput:focus {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    background-color: white !important;
    color: black !important;
}

/* Ensure all text elements are black */
h1, h2, h3, h4, h5, h6, p, span, div, small {
    color: black !important;
}

/* Override any muted text to be visible */
.text-muted {
    color: #666 !important;
}

/* Ensure cards have white background */
.card {
    background-color: white !important;
    border: 1px solid #ddd !important;
}

.card-header {
    background-color: #f8f9fa !important;
    color: black !important;
    border-bottom: 1px solid #ddd !important;
}

.card-body {
    background-color: white !important;
    color: black !important;
}

/* Video Call Styles */
.video-call-area {
    border-bottom: 1px solid #dee2e6;
}

.video-controls {
    display: flex !important;
    flex-direction: row !important;
    gap: 10px;
    align-items: center;
    justify-content: center;
}

.video-controls button {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-controls button.muted {
    background-color: #dc3545;
    border-color: #dc3545;
}

.video-controls button.video-off {
    background-color: #dc3545;
    border-color: #dc3545;
}

#adminLocalVideo {
    cursor: pointer;
    transition: all 0.3s ease;
}

#adminLocalVideo:hover {
    transform: scale(1.05);
}

.call-status {
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
}

/* Video Call Buttons */
.video-call-buttons {
    margin-top: 8px;
}

.video-call-buttons .btn-sm {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
}

.video-call-notification .alert {
    font-size: 0.85rem;
    margin-bottom: 0.5rem !important;
}

.video-call-notification .alert-info {
    background-color: #e3f2fd;
    border-color: #2196f3;
    color: #1976d2;
}

/* Responsive video */
@media (max-width: 768px) {
    #adminLocalVideo {
        width: 140px;
        height: 105px;
    }
    
    /* Masaüstü kontrolleri gizle */
    .admin-vertical-controls {
        display: none !important;
    }
    
    /* Mobil kontrolleri göster - Sol tarafta */
    .admin-mobile-controls {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
        position: absolute !important;
        top: 50% !important;
        left: 15px !important;
        transform: translateY(-50%) !important;
        z-index: 15 !important;
        background: rgba(0,0,0,0.85) !important;
        backdrop-filter: blur(15px) !important;
        padding: 10px !important;
        border-radius: 20px !important;
        border: 1px solid rgba(255,255,255,0.2) !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
    }
    
    .admin-mobile-control {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        border: 2px solid rgba(255,255,255,0.8) !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }
    
    .admin-mobile-control i {
        font-size: 14px !important;
        color: white !important;
    }
    
    .admin-mobile-control:hover {
        transform: scale(1.05) !important;
        transition: all 0.2s ease !important;
    }
    
    .admin-mobile-control.muted {
        background: rgba(220,53,69,0.9) !important;
    }
    
    .admin-mobile-control.video-off {
        background: rgba(220,53,69,0.9) !important;
    }
}

/* Masaüstünde mobil kontrolleri gizle */
@media (min-width: 769px) {
    .admin-mobile-controls {
        display: none !important;
    }
    
    .admin-vertical-controls {
        display: flex !important;
    }
}
</style>

<script>
let currentSessionID = null;
let pollInterval = null;
let searchTerm = ''; // Arama terimi için global değişken

// Video Call Variables
let adminLocalStream = null;
let adminRemoteStream = null;
let adminPeerConnection = null;
let isAdminCallActive = false;
let isAdminVideoOff = false;
let pendingVideoCallSession = null;
let adminCurrentFacingMode = 'user';
let adminIsMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
    ('ontouchstart' in window) || 
    (navigator.maxTouchPoints > 0);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    startSessionPolling();
    
    // Send message on button click
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    
    // Send message on Enter key
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Video call event listeners
    document.getElementById('acceptVideoCallBtn').addEventListener('click', acceptVideoCall);
    document.getElementById('rejectVideoCallBtn').addEventListener('click', rejectVideoCall);
    document.getElementById('endAdminCallBtn').addEventListener('click', endAdminVideoCall);
    document.getElementById('adminToggleVideoBtn').addEventListener('click', adminToggleVideo);
    
    // Mobile video call event listeners
    document.getElementById('adminMobileToggleVideoBtn').addEventListener('click', adminToggleVideo);
    
    // Admin video call başlatma
    document.getElementById('startVideoCallBtn').addEventListener('click', startAdminVideoCall);
    document.getElementById('endAdminCallBtn2').addEventListener('click', endAdminVideoCall);
});

// Load chat for selected session
function loadChat(sessionID, username) {
    currentSessionID = sessionID;
    
    // Update UI
    document.getElementById('chatHeader').innerHTML = `
        <i class="fas fa-comment-dots me-2"></i>${username} ile Sohbet
        <small class="ms-2">(${sessionID.substring(0, 8)}...)</small>
    `;
    document.getElementById('chatInput').style.display = 'block';
    
    // Show admin video call controls
    document.getElementById('adminVideoCallControls').style.display = 'block';
    document.getElementById('videoCallControls').style.display = 'none';
    
    // Show camera switch button for mobile devices
    if (adminIsMobileDevice) {
        document.getElementById('adminSwitchCameraBtn').style.display = 'inline-block';
    }
    
    // Mark session as active
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-session-id="${sessionID}"]`).classList.add('active');
    
    // Load messages
    loadMessages();
    
    // Start polling for this session
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    startMessagePolling();
    
    // Focus on input
    document.getElementById('messageInput').focus();
}

// Load messages for current session
function loadMessages() {
    if (!currentSessionID) return;
    
    fetch(`/admin/support/messages/${currentSessionID}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.messages);
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

// Display messages
function displayMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    if (messages && messages.length > 0) {
        messages.forEach(message => {
            addMessage(message);
        });
        scrollToBottom();
    } else {
        chatMessages.innerHTML = `
            <div class="text-center" style="color: #666;">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>Henüz mesaj yok. İlk mesajı gönderin!</p>
            </div>
        `;
    }
}

// Add single message
function addMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_admin ? 'admin' : 'user'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.textContent = message.message;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    const messageTime = new Date(message.created_at);
    timeDiv.textContent = `${message.username} - ${messageTime.toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit'
    })}`;
    
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    chatMessages.appendChild(messageDiv);
}

// Send message
function sendMessage() {
    if (!currentSessionID) return;
    
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    fetch(`/admin/support/send/${currentSessionID}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            addMessage(data.message);
            scrollToBottom();
        } else {
            alert('Mesaj gönderilemedi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Mesaj gönderilirken hata oluştu');
    })
    .finally(() => {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    });
}

// Scroll to bottom
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Start polling for sessions
function startSessionPolling() {
    setInterval(() => {
        loadSessions();
        checkVideoCallRequests(); // Check for video call requests globally
    }, 3000); // Poll every 3 seconds
}

// Start polling for messages
function startMessagePolling() {
    pollInterval = setInterval(() => {
        loadMessages();
        checkVideoCallRequests(); // Check for video call requests
    }, 2000); // Poll every 2 seconds
}

// Load sessions
function loadSessions() {
    fetch('/admin/support/sessions')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Check if data.sessions exists, otherwise pass empty array
            const sessions = data.sessions || [];
            updateSessionsList(sessions);
        } else {
            console.error('Failed to load sessions:', data.error);
            updateSessionsList([]); // Pass empty array on error
        }
    })
    .catch(error => {
        console.error('Error loading sessions:', error);
        updateSessionsList([]); // Pass empty array on error
    });
}

// Arama fonksiyonu
function filterSessions() {
    const searchInput = document.getElementById('sessionSearchInput');
    searchTerm = searchInput.value.toLowerCase().trim();
    
    // Tüm session itemları al
    const sessionItems = document.querySelectorAll('.session-item');
    
    sessionItems.forEach(item => {
        const usernameElement = item.querySelector('h6');
        if (usernameElement) {
            const username = usernameElement.textContent.toLowerCase();
            
            if (searchTerm === '' || username.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        }
    });
    
    // Görünen session sayısını güncelle
    const visibleSessions = document.querySelectorAll('.session-item[style*="display: block"], .session-item:not([style*="display: none"])');
    const sessionCount = document.getElementById('sessionCount');
    sessionCount.textContent = visibleSessions.length;
}

// Arama temizleme fonksiyonu
function clearSearch() {
    const searchInput = document.getElementById('sessionSearchInput');
    searchInput.value = '';
    searchTerm = '';
    filterSessions();
    searchInput.focus();
}

// Update sessions list
function updateSessionsList(sessions) {
    const sessionsList = document.getElementById('sessionsList');
    const sessionCount = document.getElementById('sessionCount');
    
    // Check if sessions is null or undefined
    if (!sessions || sessions.length === 0) {
        sessionsList.innerHTML = `
            <div class="p-4 text-center" style="color: #666;">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>Henüz aktif sohbet yok</p>
            </div>
        `;
        sessionCount.textContent = '0';
        return;
    }
    
    sessionsList.innerHTML = '';
    let visibleCount = 0;
    
    sessions.forEach(session => {
        const sessionDiv = document.createElement('div');
        sessionDiv.className = 'session-item p-3 border-bottom';
        sessionDiv.style.backgroundColor = 'white';
        sessionDiv.style.color = 'black';
        if (currentSessionID === session.session_id) {
            sessionDiv.classList.add('active');
        }
        sessionDiv.setAttribute('data-session-id', session.session_id);
        
        const lastMessageTime = new Date(session.last_message_at);
        
        sessionDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2" onclick="loadChat('${session.session_id}', '${session.username}')" style="cursor: pointer;">
                <div>
                    <h6 class="mb-1" style="color: black;">${session.username}</h6>
                    <small style="color: #666;">
                        <i class="fas fa-clock me-1"></i>
                        ${lastMessageTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                    </small>
                </div>
                <div>
                    ${session.unread_count > 0 ? `<span class="badge bg-danger">${session.unread_count}</span>` : ''}
                </div>
            </div>
            
            <!-- Video Call Notification -->
            <div id="videoCallNotification-${session.session_id}" class="video-call-notification mb-2" style="display: none;">
                <div class="alert alert-info alert-sm mb-2 py-2">
                    <i class="fas fa-video me-1"></i><strong>${session.username}</strong> görüntülü görüşme istiyor
                </div>
            </div>
            
            <!-- Video Call Buttons -->
            <div id="videoCallButtons-${session.session_id}" class="video-call-buttons" style="display: none;">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-sm flex-fill" onclick="acceptVideoCall('${session.session_id}', '${session.username}')">
                        <i class="fas fa-video me-1"></i>Cevap Ver
                    </button>
                    <button type="button" class="btn btn-danger btn-sm flex-fill" onclick="rejectVideoCall('${session.session_id}', '${session.username}')">
                        <i class="fas fa-times me-1"></i>Reddet
                    </button>
                </div>
            </div>
        `;
        
        sessionsList.appendChild(sessionDiv);
        
        // Arama terimine göre görünürlüğü kontrol et
        if (searchTerm === '' || session.username.toLowerCase().includes(searchTerm)) {
            sessionDiv.style.display = 'block';
            visibleCount++;
        } else {
            sessionDiv.style.display = 'none';
        }
    });
    
    // Görünen session sayısını güncelle
    sessionCount.textContent = visibleCount;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    if (isAdminCallActive) {
        endAdminVideoCall();
    }
});

// Video Call Functions
async function acceptVideoCall(sessionId, username) {
    try {
        currentSessionID = sessionId;
        pendingVideoCallSession = sessionId;
        
        // Load chat for this session first
        await loadChat(sessionId, username);
        
        // Start video call
        adminLocalStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        
        document.getElementById('adminLocalVideo').srcObject = adminLocalStream;
        
        // Show video call area
        document.getElementById('adminVideoCallArea').style.display = 'block';
        document.getElementById('endAdminCallBtn').style.display = 'inline-block';
        
        // Adjust chat area height
        document.getElementById('chatMessages').style.height = '300px';
        
        isAdminCallActive = true;
        document.getElementById('adminCallStatusText').textContent = 'Video görüşme aktif';
        
        // Hide video call buttons for this session
        const buttonsDiv = document.getElementById(`videoCallButtons-${sessionId}`);
        const notificationDiv = document.getElementById(`videoCallNotification-${sessionId}`);
        
        if (buttonsDiv) buttonsDiv.style.display = 'none';
        if (notificationDiv) notificationDiv.style.display = 'none';
        
        // Initialize WebRTC peer connection
        await initializeAdminPeerConnection();
        
        // Start signaling polling
        startAdminSignalingPolling();
        
        // Send call-accepted message to customer first
        await sendAdminSignalingMessage({
            type: 'call-accepted'
        });
        
        // Send acceptance to customer
        await sendVideoCallResponse('accept', sessionId);
        
        // Add system message
        addAdminSystemMessage(`${username} ile video görüşme başlatıldı. Müşteri yanıtını bekliyor...`);
        
        // Video call talebi mesajını gizle
        const videoCallNotification = document.getElementById(`videoCallNotification-${currentSessionID}`);
        const videoCallButtons = document.getElementById(`videoCallButtons-${currentSessionID}`);
        
        if (videoCallNotification) {
            videoCallNotification.style.display = 'none';
        }
        if (videoCallButtons) {
            videoCallButtons.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Video call kabul edilemedi:', error);
        alert('Kamera veya mikrofon erişimi reddedildi. Lütfen tarayıcı ayarlarınızdan izin verin.');
        await sendVideoCallResponse('reject', sessionId);
    }
}

// Reject video call from session list
async function rejectVideoCall(sessionId, username) {
    // Hide video call buttons for this session
    const buttonsDiv = document.getElementById(`videoCallButtons-${sessionId}`);
    const notificationDiv = document.getElementById(`videoCallNotification-${sessionId}`);
    
    if (buttonsDiv) buttonsDiv.style.display = 'none';
    if (notificationDiv) notificationDiv.style.display = 'none';
    
    // Send rejection to customer
    await sendVideoCallResponse('reject', sessionId);
    
    // Add system message if this is current session
    if (sessionId === currentSessionID) {
        addAdminSystemMessage(`${username} ile video görüşme talebi reddedildi.`);
    }
}

// Admin video call başlatma
async function startAdminVideoCall() {
    if (!currentSessionID) {
        alert('Önce bir sohbet seçin');
        return;
    }
    
    try {
        // Get session info
        const sessionElement = document.querySelector(`[data-session-id="${currentSessionID}"]`);
        const username = sessionElement.querySelector('h6').textContent;
        
        // Send admin video call request to backend
        const response = await fetch('/admin/support/start-video-call', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: currentSessionID
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            alert('Video call talebi gönderilemedi: ' + data.error);
            return;
        }
        
        // Start video call
        adminLocalStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        
        document.getElementById('adminLocalVideo').srcObject = adminLocalStream;
        
        // Show video call area
        document.getElementById('adminVideoCallArea').style.display = 'block';
        document.getElementById('endAdminCallBtn').style.display = 'inline-block';
        document.getElementById('endAdminCallBtn2').style.display = 'inline-block';
        document.getElementById('startVideoCallBtn').style.display = 'none';
        
        // Adjust chat area height
        document.getElementById('chatMessages').style.height = '300px';
        
        isAdminCallActive = true;
        document.getElementById('adminCallStatusText').textContent = 'Video görüşme başlatılıyor...';
        
        // Initialize WebRTC peer connection
        await initializeAdminPeerConnection();
        
        // Start signaling polling
        startAdminSignalingPolling();
        
        // Create and send offer to customer
        const offer = await adminPeerConnection.createOffer();
        await adminPeerConnection.setLocalDescription(offer);
        
        await sendAdminSignalingMessage({
            type: 'offer',
            sdp: offer
        });
        
        console.log('Admin sent offer to customer');
        
        // Add system message
        addAdminSystemMessage(`${username} ile video görüşme başlatıldı. Müşteri yanıtını bekliyor...`);
        
    } catch (error) {
        console.error('Admin video call başlatılamadı:', error);
        alert('Kamera veya mikrofon erişimi reddedildi. Lütfen tarayıcı ayarlarınızdan izin verin.');
    }
}

async function endAdminVideoCall() {
    try {
        // Stop local stream
        if (adminLocalStream) {
            adminLocalStream.getTracks().forEach(track => track.stop());
            adminLocalStream = null;
        }
        
        // Close peer connection
        if (adminPeerConnection) {
            adminPeerConnection.close();
            adminPeerConnection = null;
        }
        
        // Hide video call area
        document.getElementById('adminVideoCallArea').style.display = 'none';
        document.getElementById('endAdminCallBtn').style.display = 'none';
        
        // Reset chat area height
        document.getElementById('chatMessages').style.height = '400px';
        
        // Reset video elements
        document.getElementById('adminLocalVideo').srcObject = null;
        document.getElementById('adminRemoteVideo').srcObject = null;
        
        // Reset states
        isAdminCallActive = false;
        isAdminVideoOff = false;
        
        // Reset admin call message flag
        window.adminCallMessageShown = false;
        
        // Stop signaling polling
        stopAdminSignalingPolling();
        
        // Reset button states
        document.getElementById('adminToggleMuteBtn').classList.remove('muted');
        document.getElementById('adminToggleVideoBtn').classList.remove('video-off');
        document.getElementById('adminToggleMuteBtn').innerHTML = '<i class="fas fa-microphone"></i>';
        document.getElementById('adminToggleVideoBtn').innerHTML = '<i class="fas fa-video"></i>';
        
        // Reset mobile button states
        document.getElementById('adminMobileToggleMuteBtn').classList.remove('muted');
        document.getElementById('adminMobileToggleVideoBtn').classList.remove('video-off');
        document.getElementById('adminMobileToggleMuteBtn').innerHTML = '<i class="fas fa-microphone"></i>';
        document.getElementById('adminMobileToggleVideoBtn').innerHTML = '<i class="fas fa-video"></i>';
        
        // Send end call notification
        await sendVideoCallResponse('end');
        
        // Add system message
        addAdminSystemMessage('Video görüşme sonlandırıldı.');
        
    } catch (error) {
        console.error('Video call sonlandırma hatası:', error);
    }
}



function adminToggleVideo() {
    if (adminLocalStream) {
        const videoTrack = adminLocalStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isAdminVideoOff = !videoTrack.enabled;
            
            const desktopBtn = document.getElementById('adminToggleVideoBtn');
            const mobileBtn = document.getElementById('adminMobileToggleVideoBtn');
            
            if (isAdminVideoOff) {
                desktopBtn.classList.add('video-off');
                desktopBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                mobileBtn.classList.add('video-off');
                mobileBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
            } else {
                desktopBtn.classList.remove('video-off');
                desktopBtn.innerHTML = '<i class="fas fa-video"></i>';
                mobileBtn.classList.remove('video-off');
                mobileBtn.innerHTML = '<i class="fas fa-video"></i>';
            }
        }
    }
}

// Initialize WebRTC peer connection for admin
async function initializeAdminPeerConnection() {
    try {
        console.log('Initializing admin peer connection...');
        
        // Create peer connection with STUN servers
        adminPeerConnection = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        });
        
        // Add local stream to peer connection
        adminLocalStream.getTracks().forEach(track => {
            adminPeerConnection.addTrack(track, adminLocalStream);
        });
        
        // Handle remote stream - DÜZELTME
        adminPeerConnection.ontrack = (event) => {
            console.log('Admin received remote stream:', event);
            if (event.streams && event.streams[0]) {
                adminRemoteStream = event.streams[0];
                const adminRemoteVideo = document.getElementById('adminRemoteVideo');
                if (adminRemoteVideo) {
                    console.log('Setting customer stream to admin video element');
                    adminRemoteVideo.srcObject = adminRemoteStream;
                    
                    // Video metadata yüklendiğinde
                    adminRemoteVideo.onloadedmetadata = () => {
                        console.log('Admin remote video metadata loaded');
                        console.log('Customer video dimensions:', adminRemoteVideo.videoWidth, 'x', adminRemoteVideo.videoHeight);
                        
                        // Video oynatmayı başlat
                        adminRemoteVideo.play().then(() => {
                            console.log('Customer video started playing in admin panel');
                            document.getElementById('adminCallStatusText').textContent = 'Müşteri bağlandı - Video aktif';
                        }).catch(error => {
                            console.error('Error playing customer video:', error);
                            // Kullanıcı etkileşimi gerekebilir
                            adminRemoteVideo.muted = true;
                            adminRemoteVideo.play();
                        });
                    };
                    
                    // Video oynatma olayları
                    adminRemoteVideo.onplay = () => console.log('Customer video playing in admin');
                    adminRemoteVideo.onpause = () => console.log('Customer video paused in admin');
                    adminRemoteVideo.onerror = (error) => console.error('Customer video error in admin:', error);
                    
                    // Video yüklenme durumu
                    adminRemoteVideo.oncanplay = () => {
                        console.log('Customer video can play in admin');
                        adminRemoteVideo.play();
                    };
                } else {
                    console.error('Admin remote video element not found');
                }
            } else {
                console.error('No remote stream in admin track event');
            }
        };
        
        // Handle ICE candidates
        adminPeerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                sendAdminSignalingMessage({
                    type: 'ice-candidate',
                    candidate: event.candidate
                });
            }
        };
        
        // Handle connection state changes
        adminPeerConnection.onconnectionstatechange = () => {
            console.log('Admin connection state:', adminPeerConnection.connectionState);
            switch (adminPeerConnection.connectionState) {
                case 'connected':
                    document.getElementById('adminCallStatusText').textContent = 'Bağlantı aktif';
                    break;
                case 'disconnected':
                    document.getElementById('adminCallStatusText').textContent = 'Bağlantı kesildi';
                    break;
                case 'failed':
                    document.getElementById('adminCallStatusText').textContent = 'Bağlantı başarısız';
                    break;
            }
        };
        
        console.log('Admin peer connection initialized, waiting for customer offer...');
        
    } catch (error) {
        console.error('Admin peer connection initialization failed:', error);
    }
}

// Send signaling message to customer
async function sendAdminSignalingMessage(message) {
    try {
        const response = await fetch('/admin/support/webrtc-signal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: currentSessionID,
                message: message
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Admin signaling message failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending admin signaling message:', error);
    }
}

// Handle incoming signaling messages for admin
async function handleAdminSignalingMessage(message) {
    try {
        console.log('Admin handling signaling message:', message);
        switch (message.type) {
            case 'offer':
                // Customer sent offer, create answer
                await adminPeerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                const answer = await adminPeerConnection.createAnswer();
                await adminPeerConnection.setLocalDescription(answer);
                sendAdminSignalingMessage({
                    type: 'answer',
                    sdp: answer
                });
                console.log('Admin sent answer to customer offer');
                break;
                
            case 'answer':
                await adminPeerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                break;
                
            case 'ice-candidate':
                await adminPeerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                break;
        }
    } catch (error) {
        console.error('Error handling admin signaling message:', error);
    }
}

async function sendVideoCallResponse(action, sessionId = null) {
    try {
        const response = await fetch('/admin/support/video-call-response', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId || pendingVideoCallSession || currentSessionID,
                action: action
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call response failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending video call response:', error);
    }
}

function addAdminSystemMessage(message) {
    // Video görüşme talebi mesajlarını gizle
    if (message.includes('Görüntülü görüşme talebi gönderildi') || 
        message.includes('Video görüşme talebi gönderildi') ||
        message.includes('📞 Görüntülü görüşme talebi gönderildi')) {
        return; // Bu mesajları gösterme
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message system';
    messageDiv.style.textAlign = 'center';
    messageDiv.style.marginBottom = '15px';
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.style.display = 'inline-block';
    bubbleDiv.style.background = '#17a2b8';
    bubbleDiv.style.color = 'white';
    bubbleDiv.style.padding = '8px 16px';
    bubbleDiv.style.borderRadius = '15px';
    bubbleDiv.style.fontSize = '0.9em';
    bubbleDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i>' + message;
    
    messageDiv.appendChild(bubbleDiv);
    document.getElementById('chatMessages').appendChild(messageDiv);
    scrollToBottom();
}

// Check for video call requests for all sessions
function checkVideoCallRequests() {
    fetch('/admin/support/video-call-requests')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.requests) {
            // Check if there are new requests (for sound notification)
            const hasNewRequests = data.requests.length > 0;
            const currentRequests = data.requests.map(r => r.session_id);
            
            // Hide all existing video call buttons first
            document.querySelectorAll('.video-call-buttons').forEach(buttons => {
                buttons.style.display = 'none';
            });
            document.querySelectorAll('.video-call-notification').forEach(notification => {
                notification.style.display = 'none';
            });
            
            // Show buttons for sessions with pending requests
            data.requests.forEach(request => {
                const sessionId = request.session_id;
                const username = request.username || 'Misafir';
                
                // Sadece müşteri arama başlattıysa butonları göster
                if (request.initiator !== 'admin') {
                    // Show video call buttons for this session
                    const buttonsDiv = document.getElementById(`videoCallButtons-${sessionId}`);
                    const notificationDiv = document.getElementById(`videoCallNotification-${sessionId}`);
                    
                    if (buttonsDiv) {
                        buttonsDiv.style.display = 'block';
                    }
                    
                    if (notificationDiv) {
                        notificationDiv.style.display = 'block';
                        // Update notification text with username
                        const alertDiv = notificationDiv.querySelector('.alert');
                        if (alertDiv) {
                            alertDiv.innerHTML = `<i class="fas fa-video me-1"></i><strong>${username}</strong> görüntülü görüşme istiyor`;
                        }
                    }
                } else {
                    // Admin arama başlattıysa butonları gösterme, sadece bilgi mesajı göster
                    if (sessionId === currentSessionID && !isAdminCallActive && !window.adminCallMessageShown) {
                        addAdminSystemMessage(`Video görüşme başlatıldı, müşteri yanıtını bekliyor...`);
                        window.adminCallMessageShown = true; // Mesajın tekrar gösterilmesini engelle
                    }
                }
            });
            
            // Play notification sound if there are new requests
            if (hasNewRequests && (!window.lastVideoCallRequests || 
                JSON.stringify(currentRequests.sort()) !== JSON.stringify(window.lastVideoCallRequests.sort()))) {
                playNotificationSound();
                window.lastVideoCallRequests = currentRequests;
            }
        } else {
            // No requests, clear the last requests
            window.lastVideoCallRequests = [];
        }
    })
    .catch(error => {
        console.error('Error checking video call requests:', error);
    });
}

// Play notification sound for video call requests
function playNotificationSound() {
    try {
        // Create a simple notification beep sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configure the beep sound
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz frequency
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // 30% volume
        
        // Play beep for 200ms, pause, then repeat 2 more times
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        
        // Second beep
        setTimeout(() => {
            try {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator2.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Second beep failed:', e);
            }
        }, 300);
        
        // Third beep
        setTimeout(() => {
            try {
                const oscillator3 = audioContext.createOscillator();
                const gainNode3 = audioContext.createGain();
                oscillator3.connect(gainNode3);
                gainNode3.connect(audioContext.destination);
                oscillator3.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode3.gain.setValueAtTime(0.3, audioContext.currentTime);
                oscillator3.start(audioContext.currentTime);
                oscillator3.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Third beep failed:', e);
            }
        }, 600);
        
        console.log('🔊 Video call notification sound played');
        
    } catch (error) {
        console.log('Notification sound failed (normal in some browsers):', error);
    }
}

// Start admin signaling polling
function startAdminSignalingPolling() {
    if (window.adminSignalingInterval) {
        clearInterval(window.adminSignalingInterval);
    }
    
    window.adminSignalingInterval = setInterval(async () => {
        if (!isAdminCallActive || !currentSessionID) return;
        
        try {
            const response = await fetch(`/admin/support/webrtc-signals/${currentSessionID}`);
            const data = await response.json();
            
            if (data.success && data.messages) {
                for (const message of data.messages) {
                    await handleAdminSignalingMessage(message);
                }
            }
        } catch (error) {
            console.error('Error polling admin signaling messages:', error);
        }
    }, 1000);
}

// Stop admin signaling polling
function stopAdminSignalingPolling() {
    if (window.adminSignalingInterval) {
        clearInterval(window.adminSignalingInterval);
        window.adminSignalingInterval = null;
    }
}

// Load admin sessions (alias for loadSessions)
function loadAdminSessions() {
    loadSessions();
}

// Admin kamera değiştirme fonksiyonu - DÜZELTİLMİŞ
async function adminSwitchCameras() {
    if (!adminIsMobileDevice || !adminLocalStream) return;
    
    const notification = document.getElementById('adminCameraSwitch');
    if (notification) notification.style.display = 'block';
    
    try {
        // Mevcut video track'i al
        const videoTrack = adminLocalStream.getVideoTracks()[0];
        if (!videoTrack) return;
        
        // Ön kamera (user) ile arka kamera (environment) arasında geçiş
        const newFacingMode = adminCurrentFacingMode === 'user' ? 'environment' : 'user';
        
        const constraints = {
            video: {
                facingMode: { ideal: newFacingMode }, // ✅ İyi: ideal kullanılmış
                width: { ideal: 640, min: 320 },
                height: { ideal: 480, min: 240 },
                frameRate: { ideal: 30 }
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        };
        
        // Eski stream'i durdur
        adminLocalStream.getTracks().forEach(track => track.stop());
        
        // Yeni stream al
        adminLocalStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Yerel video elementini güncelle
        const adminLocalVideo = document.getElementById('adminLocalVideo');
        adminLocalVideo.srcObject = adminLocalStream;
        
        // WebRTC bağlantısında track'leri değiştir
        if (adminPeerConnection) {
            const videoSender = adminPeerConnection.getSenders().find(s => 
                s.track && s.track.kind === 'video'
            );
            const audioSender = adminPeerConnection.getSenders().find(s => 
                s.track && s.track.kind === 'audio'
            );
            
            if (videoSender) {
                await videoSender.replaceTrack(adminLocalStream.getVideoTracks()[0]);
            }
            if (audioSender) {
                await audioSender.replaceTrack(adminLocalStream.getAudioTracks()[0]);
            }
            
            console.log('Admin camera switched successfully');
        }
        
        adminCurrentFacingMode = newFacingMode;
        
        if (notification) {
            notification.innerHTML = '<i class="fas fa-check me-2"></i>Kamera değiştirildi!';
            setTimeout(() => {
                notification.style.display = 'none';
                notification.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>Kamera değiştiriliyor...';
            }, 1500);
        }
        
    } catch (error) {
        console.error('Kamera değiştirilemedi:', error);
        
        // ✅ İyi: Fallback mekanizması var - Hata durumunda ön kameraya geri dön
        try {
            adminLocalStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' },
                audio: true
            });
            const adminLocalVideo = document.getElementById('adminLocalVideo');
            adminLocalVideo.srcObject = adminLocalStream;
            adminCurrentFacingMode = 'user';
        } catch (fallbackError) {
            console.error('Ön kameraya dönüş hatası:', fallbackError);
        }
        
        if (notification) {
            notification.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Kamera değiştirilemedi!';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadAdminSessions();
    setInterval(loadAdminSessions, 3000); // 3 saniye
    setInterval(checkVideoCallRequests, 2000); // 2 saniye
});
</script>
</body>
</html>
