{{template "base.html" .}}

{{define "content"}}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-comments me-2"></i>Canlƒ± Destek
                            </h4>
                            <small>Sorularƒ±nƒ±z i√ßin 7/24 buradayƒ±z!</small>
                        </div>
                        <div>
                            <button id="videoCallBtn" class="btn btn-success btn-lg" title="G√∂r√ºnt√ºl√º G√∂r√º≈ümeye Ge√ß" style="font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.3); animation: pulse-glow 2s infinite;">
                                <i class="fas fa-video me-2"></i>üìû G√∂r√ºnt√ºl√º G√∂r√º≈üme
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Video Call Area -->
                    <div id="videoCallArea" class="video-call-area" style="display: none; height: 300px; background: #000; position: relative;">
                        <video id="localVideo" autoplay muted style="width: 150px; height: 100px; position: absolute; top: 10px; right: 10px; border: 2px solid #fff; border-radius: 8px; z-index: 10;"></video>
                        <video id="remoteVideo" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                        <div class="video-controls" style="position: absolute; bottom: 10px; right: 20px; z-index: 10; display: flex; flex-direction: row; gap: 10px;">
                            <button id="toggleMuteBtn" class="btn btn-secondary btn-sm" title="Mikrofonu A√ß/Kapat">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button id="toggleVideoBtn" class="btn btn-secondary btn-sm" title="Kamerayƒ± A√ß/Kapat">
                                <i class="fas fa-video"></i>
                            </button>
                            <button id="endCallBtn" class="btn btn-danger btn-sm" title="G√∂r√º≈ümeyi Sonlandƒ±r">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                        </div>
                        <div class="call-status" style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                            <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                            <span id="callStatusText">Baƒülantƒ± kuruluyor...</span>
                        </div>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Merhaba! Size nasƒ±l yardƒ±mcƒ± olabiliriz?</p>
                            <div class="mt-3">
                                <button id="videoCallBtn2" class="btn btn-success btn-md" onclick="startVideoCall()" style="font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.2);">
                                    <i class="fas fa-video me-2"></i>üìû Hƒ±zlƒ± G√∂r√ºnt√ºl√º G√∂r√º≈üme
                                </button>
                                <p class="mt-2 small text-muted">Mesaj yazmadan direkt g√∂r√ºnt√ºl√º g√∂r√º≈üme ba≈ülatabilirsiniz!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="chat-input border-top p-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." maxlength="500">
                            <button class="btn btn-primary" id="sendButton" type="button">
                                <i class="fas fa-paper-plane"></i> G√∂nder
                            </button>
                        </div>
                        <small class="text-muted">Enter tu≈üuna basarak da mesaj g√∂nderebilirsiniz</small>
                    </div>
                </div>
            </div>
            
            <!-- Support Info -->
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Destek Saatleri:</strong> 7/24 online destek hizmeti veriyoruz. 
                Mesajlarƒ±nƒ±z en kƒ±sa s√ºrede yanƒ±tlanacaktƒ±r.
            </div>
            
            <!-- Safari Compatibility Info -->
            <div id="safariInfo" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-safari me-2"></i>
                <strong>Safari Kullanƒ±cƒ±larƒ± ƒ∞√ßin:</strong>
                <ul class="mb-0 mt-2">
                    <li>iOS 11.3+ veya macOS High Sierra+ gereklidir</li>
                    <li>Kamera ve mikrofon izni vermeniz gerekecek</li>
                    <li>Yerel aƒüda test i√ßin: <code>https://192.168.1.133:8081</code></li>
                    <li>Sorun ya≈üarsanƒ±z Chrome veya Firefox deneyebilirsiniz</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user {
    text-align: right;
}

.message.admin {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.admin .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}

.message.user .message-time {
    text-align: right;
    color: #fff;
}

.message.admin .message-time {
    text-align: left;
    color: #666;
}

.typing-indicator {
    text-align: left;
    margin-bottom: 15px;
}

.typing-bubble {
    display: inline-block;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 18px;
    padding: 12px 16px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.chat-input {
    background: white;
}

#messageInput:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Video Call Styles */
.video-call-area {
    border-bottom: 1px solid #dee2e6;
}

/* Video Call Button Animation */
@keyframes pulse-glow {
    0% {
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.6);
        transform: scale(1.05);
    }
    100% {
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transform: scale(1);
    }
}

#videoCallBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(40, 167, 69, 0.8);
    transition: all 0.3s ease;
}

.video-controls {
    display: flex !important;
    flex-direction: row !important;
    gap: 10px;
    align-items: center;
    justify-content: center;
}

.video-controls button {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-controls button.muted {
    background-color: #dc3545;
    border-color: #dc3545;
}

.video-controls button.video-off {
    background-color: #dc3545;
    border-color: #dc3545;
}

#localVideo {
    cursor: pointer;
    transition: all 0.3s ease;
}

#localVideo:hover {
    transform: scale(1.05);
}

.call-status {
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
}

/* Responsive video */
@media (max-width: 768px) {
    #localVideo {
        width: 100px;
        height: 75px;
    }
    
    .video-controls button {
        width: 35px;
        height: 35px;
    }
    
    /* Safari mobile specific */
    .video-call-area {
        height: 250px !important;
    }
    
    .chat-messages {
        height: 180px !important;
    }
}

/* Safari-specific styles */
@supports (-webkit-appearance: none) {
    #localVideo, #remoteVideo {
        -webkit-playsinline: true;
        -webkit-transform: translateZ(0);
        backface-visibility: hidden;
    }
    
    .video-call-area {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
    
    #videoCallBtn {
        -webkit-appearance: none;
        border-radius: 6px;
    }
}

/* iOS Safari specific */
@supports (-webkit-touch-callout: none) {
    .video-controls {
        padding-bottom: 20px; /* Account for iOS home indicator */
    }
    
    .chat-input {
        padding-bottom: 25px; /* Account for iOS keyboard */
    }
    
    #messageInput {
        font-size: 16px; /* Prevent zoom on iOS */
    }
}
</style>

<script>
let sessionID = '{{.sessionID}}';
let lastMessageTime = null;
let pollInterval;

// SessionID'yi d√∂nd√ºren fonksiyon
function getSessionID() {
    return sessionID;
}

// Video Call Variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isCallActive = false;
let isMuted = false;
let isVideoOff = false;
let videoCallRequested = false; // Video call talebi g√∂nderildi mi?

// DOM Elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const videoCallBtn = document.getElementById('videoCallBtn');
const videoCallArea = document.getElementById('videoCallArea');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const toggleMuteBtn = document.getElementById('toggleMuteBtn');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const callStatusText = document.getElementById('callStatusText');

// Interval ID'lerini sakla
let webrtcInterval;
let pingInterval;
let cartInterval;

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    console.log('SessionID:', sessionID); // Debug log
    
    // SessionID kontrol√º - eƒüer bo≈üsa yeni olu≈ütur
    if (!sessionID || sessionID === '') {
        sessionID = generateSessionID();
        console.log('New SessionID generated:', sessionID);
        // Cookie'ye kaydet
        document.cookie = `user_session=${sessionID}; path=/; max-age=${3600*24*30}`;
    }
    
    // ƒ∞lk ping'i hemen g√∂nder
    fetch('/support/ping', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Initial ping sent successfully');
        }
    })
    .catch(error => {
        console.error('Initial ping error:', error);
    });
    
    loadMessages();
    startPolling();
    
    // Start signaling polling for incoming admin calls
    startSignalingPolling();
    
    // Check video call permissions on load
    updateVideoCallButton();
    
    // Show Safari info if using Safari
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isSafari) {
        const safariInfo = document.getElementById('safariInfo');
        if (safariInfo) {
            safariInfo.style.display = 'block';
        }
    }
    
    // Send message on button click
    sendButton.addEventListener('click', sendMessage);
    
    // Send message on Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Focus on input
    messageInput.focus();
    
    // Video call event listeners
    videoCallBtn.addEventListener('click', startVideoCall);
    
    // Toggle mute and video buttons event listeners
    if (toggleMuteBtn) {
        toggleMuteBtn.addEventListener('click', toggleMute);
    }
    if (toggleVideoBtn) {
        toggleVideoBtn.addEventListener('click', toggleVideo);
    }
    
    // Sayfa ilk a√ßƒ±ldƒ±ƒüƒ±nda G√∂r√ºnt√ºl√º Ara butonunu g√∂r√ºn√ºr yap
    videoCallBtn.style.display = 'inline-block';
    
    // Sayfa y√ºklendiƒüinde periyodik olarak sunucuya ping at
    pingInterval = setInterval(function() {
        fetch('/support/ping', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Ping sent successfully (page visible)');
            }
        })
        .catch(error => {
            console.error('Ping error (page visible):', error);
        });
    }, 15000); // 15 saniye
});

// SessionID olu≈üturma fonksiyonu
function generateSessionID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Load existing messages
function loadMessages() {
    fetch('/support/messages', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.messages);
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

// Send message
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    fetch('/support/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            addMessage(data.message);
            scrollToBottom();
        } else {
            alert('Mesaj g√∂nderilemedi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Mesaj g√∂nderilirken hata olu≈ütu');
    })
    .finally(() => {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    });
}

// Display messages
function displayMessages(messages) {
    // Clear loading message
    chatMessages.innerHTML = '';
    
    if (messages && messages.length > 0) {
        messages.forEach(message => {
            addMessage(message);
        });
        scrollToBottom();
    } else {
        showWelcomeMessage();
    }
}

// Add single message
function addMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_admin ? 'admin' : 'user'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.textContent = message.message;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    const messageTime = new Date(message.created_at);
    timeDiv.textContent = messageTime.toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    chatMessages.appendChild(messageDiv);
    
    // Update last message time
    lastMessageTime = message.created_at;
}

// Show welcome message
function showWelcomeMessage() {
    chatMessages.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <p>Merhaba! Size nasƒ±l yardƒ±mcƒ± olabiliriz?</p>
        </div>
    `;
}

// Scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Start polling for new messages
function startPolling() {
    pollInterval = setInterval(() => {
        loadMessages();
    }, 3000); // Poll every 3 seconds
}

// Sayfa g√∂r√ºn√ºrl√ºƒü√º deƒüi≈ütiƒüinde
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Sayfa gizlendiƒüinde T√úM interval'larƒ± durdur
        if (webrtcInterval) {
            clearInterval(webrtcInterval);
            webrtcInterval = null;
        }
        if (pingInterval) {
            clearInterval(pingInterval);
            pingInterval = null;
        }
        if (cartInterval) {
            clearInterval(cartInterval);
            cartInterval = null;
        }
        if (signalingPollInterval) {
            clearInterval(signalingPollInterval);
            signalingPollInterval = null;
        }
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
        // Sunucuya kullanƒ±cƒ±nƒ±n ayrƒ±ldƒ±ƒüƒ±nƒ± bildir
        navigator.sendBeacon('/support/leave');
        console.log('Sayfa gizlendi - T√ºm interval\'lar durduruldu');
    } else {
        // Sayfa tekrar g√∂r√ºn√ºr olduƒüunda hem ping hem de poll interval'ƒ±nƒ± yeniden ba≈ülat
        if (!pingInterval) {
            pingInterval = setInterval(function() {
                fetch('/support/ping', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Ping sent successfully (page visible)');
                    }
                })
                .catch(error => {
                    console.error('Ping error (page visible):', error);
                });
            }, 15000); // 15 saniye
        }
        if (!pollInterval) {
            pollInterval = setInterval(() => {
                loadMessages();
            }, 3000);
        }
        console.log('Sayfa g√∂r√ºn√ºr oldu - Ping ve poll interval yeniden ba≈ülatƒ±ldƒ±');
    }
});

// Sayfa kapatƒ±ldƒ±ƒüƒ±nda veya kullanƒ±cƒ± ayrƒ±ldƒ±ƒüƒ±nda
let pageUnloading = false;

window.addEventListener('beforeunload', function(e) {
    if (pageUnloading) return; // Prevent multiple calls
    
    pageUnloading = true;
    
    // T√ºm interval'larƒ± durdur
    if (webrtcInterval) {
        clearInterval(webrtcInterval);
        webrtcInterval = null;
    }
    if (pingInterval) {
        clearInterval(pingInterval);
        pingInterval = null;
    }
    if (cartInterval) {
        clearInterval(cartInterval);
        cartInterval = null;
    }
    if (signalingPollInterval) {
        clearInterval(signalingPollInterval);
        signalingPollInterval = null;
    }
    
    // Sunucuya kullanƒ±cƒ±nƒ±n ayrƒ±ldƒ±ƒüƒ±nƒ± bildir
    if (sessionID) {
        navigator.sendBeacon('/support/leave');
    }
    
    console.log('Sayfa kapatƒ±ldƒ± - T√ºm interval\'lar durduruldu');
});

// Manuel izin isteme fonksiyonu
async function requestMediaPermissions() {
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    try {
        // Basit kƒ±sƒ±tlamalar ile ba≈üla
        const simpleConstraints = { 
            video: true, 
            audio: true 
        };
        
        console.log('Kamera ve mikrofon izni isteniyor...');
        
        const stream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
        
        // ƒ∞zin verildi, stream'i durdur
        stream.getTracks().forEach(track => {
            track.stop();
            console.log('Track durduruldu:', track.kind);
        });
        
        console.log('‚úÖ Kamera ve mikrofon izni verildi!');
        return { success: true, message: 'ƒ∞zinler ba≈üarƒ±yla verildi!' };
        
    } catch (error) {
        console.error('‚ùå ƒ∞zin hatasƒ±:', error.name, error.message);
        
        let errorMessage = '';
        
        switch (error.name) {
            case 'NotAllowedError':
                errorMessage = `ƒ∞zin reddedildi!\n\n` +
                    `${isSafari ? 
                        `${isIOS ? 'üì± iPhone/iPad Safari:' : 'üñ•Ô∏è Mac Safari:'}\n` +
                        '1. Adres √ßubuƒüundaki üîí simgesine tƒ±klayƒ±n\n' +
                        '2. "Kamera" ve "Mikrofon" i√ßin "ƒ∞zin ver" se√ßin\n' +
                        '3. Sayfayƒ± yenileyin ve tekrar deneyin' :
                        'üñ•Ô∏è Tarayƒ±cƒ± ayarlarƒ±:\n' +
                        '1. Adres √ßubuƒüundaki üîí simgesine tƒ±klayƒ±n\n' +
                        '2. "Kamera" ve "Mikrofon" i√ßin "ƒ∞zin ver" se√ßin\n' +
                        '3. Sayfayƒ± yenileyin ve tekrar deneyin'
                    }`;
                break;
                
            case 'NotFoundError':
                errorMessage = '‚ùå Kamera veya mikrofon bulunamadƒ±!\n\n' +
                    '‚Ä¢ Cihazƒ±nƒ±zda kamera ve mikrofon olduƒüundan emin olun\n' +
                    '‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lmƒ±yor olabilir\n' +
                    '‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin';
                break;
                
            case 'NotReadableError':
                errorMessage = '‚ùå Kamera veya mikrofon kullanƒ±mda!\n\n' +
                    '‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor olabilir\n' +
                    '‚Ä¢ T√ºm kamera/mikrofon kullanan uygulamalarƒ± kapatƒ±n\n' +
                    '‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin';
                break;
                
            case 'SecurityError':
                errorMessage = '‚ùå G√ºvenlik hatasƒ±!\n\n' +
                    '‚Ä¢ HTTPS baƒülantƒ±sƒ± gerekli\n' +
                    '‚Ä¢ Tarayƒ±cƒ± ayarlarƒ±nƒ± kontrol edin\n' +
                    '‚Ä¢ Farklƒ± bir tarayƒ±cƒ± deneyin';
                break;
                
            default:
                errorMessage = `‚ùå Bilinmeyen hata: ${error.name}\n\n` +
                    '‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin\n' +
                    '‚Ä¢ Farklƒ± bir tarayƒ±cƒ± kullanmayƒ± deneyin\n' +
                    '‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin';
        }
        
        return { success: false, message: errorMessage };
    }
}

// Video arama ba≈ülatma fonksiyonunu g√ºncelle
async function startVideoCall() {
    if (isCallActive) {
        console.log('Video arama zaten aktif');
        return;
    }
    
    // ƒ∞zin kontrol√º
    const permissionResult = await requestMediaPermissions();
    
    if (!permissionResult.success) {
        alert(permissionResult.message);
        return;
    }
    
    // Video arama ba≈ülat
    try {
        isCallActive = true;
        isWaitingForResponse = true;
        
        // UI g√ºncelle
        videoCallBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aranƒ±yor...';
        videoCallBtn.disabled = true;
        
        // Admin'e video arama isteƒüi g√∂nder
        await sendVideoCallRequest();
        
        console.log('‚úÖ Video arama ba≈ülatƒ±ldƒ±');
        
    } catch (error) {
        console.error('‚ùå Video arama hatasƒ±:', error);
        isCallActive = false;
        isWaitingForResponse = false;
        
        videoCallBtn.innerHTML = '<i class="fas fa-video"></i> G√∂r√ºnt√ºl√º G√∂r√º≈üme';
        videoCallBtn.disabled = false;
        
        alert('Video arama ba≈ülatƒ±lamadƒ±. L√ºtfen tekrar deneyin.');
    }
}

async function endVideoCall() {
    try {
        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Close peer connection
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        // Hide video call area
        videoCallArea.style.display = 'none';
        videoCallBtn.style.display = 'inline-block';
        
        // Reset chat area height
        chatMessages.style.height = '400px';
        
        // Reset video elements
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        
        // Reset states
        isCallActive = false;
        isMuted = false;
        isVideoOff = false;
        videoCallRequested = false; // Video call talebini sƒ±fƒ±rla
        
        // Video call butonunu tekrar aktif hale getir
        videoCallBtn.disabled = false;
        videoCallBtn.innerHTML = '<i class="fas fa-video"></i> G√∂r√ºnt√ºl√º Ara';
        videoCallBtn.style.backgroundColor = '#28a745';
        videoCallBtn.style.cursor = 'pointer';
        videoCallBtn.style.opacity = '1';
        videoCallBtn.style.animation = 'pulse-glow 2s infinite';
        
        // Stop signaling polling
        stopSignalingPolling();
        
        // Reset button states
        toggleMuteBtn.classList.remove('muted');
        toggleVideoBtn.classList.remove('video-off');
        toggleMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        toggleVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
        
        // Send end call notification
        await sendVideoCallEnd();
        
    } catch (error) {
        console.error('Video call sonlandƒ±rma hatasƒ±:', error);
    }
}

function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;
            
            if (isMuted) {
                toggleMuteBtn.classList.add('muted');
                toggleMuteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                toggleMuteBtn.classList.remove('muted');
                toggleMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }
}

function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoOff = !videoTrack.enabled;
            
            if (isVideoOff) {
                toggleVideoBtn.classList.add('video-off');
                toggleVideoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
            } else {
                toggleVideoBtn.classList.remove('video-off');
                toggleVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }
        }
    }
}

// Initialize WebRTC Peer Connection
async function initializePeerConnection() {
    try {
        // Create peer connection with STUN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream to peer connection
        if (localStream) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }
        
        // Handle remote stream
        peerConnection.ontrack = (event) => {
            console.log('=== REMOTE STREAM EVENT ===');
            console.log('Event:', event);
            console.log('Streams:', event.streams);
            console.log('Tracks:', event.track);
            
            if (event.streams && event.streams.length > 0) {
                remoteStream = event.streams[0];
                console.log('Remote stream set:', remoteStream);
                console.log('Remote stream tracks:', remoteStream.getTracks());
                
                // Set remote video source
                if (remoteVideo) {
                    remoteVideo.srcObject = remoteStream;
                    console.log('Remote video srcObject set');
                    
                    // Force video to play
                    remoteVideo.play().then(() => {
                        console.log('Remote video playing successfully');
                        callStatusText.textContent = 'Baƒülantƒ± kuruldu - Video aktif';
                    }).catch(error => {
                        console.error('Remote video play error:', error);
                    });
                    
                    // Debug events
                    remoteVideo.onloadedmetadata = () => {
                        console.log('Remote video metadata loaded');
                        console.log('Remote video dimensions:', remoteVideo.videoWidth, 'x', remoteVideo.videoHeight);
                    };
                    
                    remoteVideo.onplay = () => {
                        console.log('Remote video started playing');
                        callStatusText.textContent = 'Baƒülantƒ± kuruldu - Video aktif';
                    };
                    
                    remoteVideo.onerror = (error) => {
                        console.error('Remote video error:', error);
                    };
                    
                    remoteVideo.oncanplay = () => {
                        console.log('Remote video can play');
                    };
                } else {
                    console.error('Remote video element not found!');
                }
            } else {
                console.error('No streams in ontrack event');
            }
            
            callStatusText.textContent = 'Baƒülantƒ± kuruldu';
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignalingMessage({
                    type: 'ice-candidate',
                    candidate: event.candidate
                });
            }
        };
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
            console.log('Connection state:', peerConnection.connectionState);
            switch (peerConnection.connectionState) {
                case 'connected':
                    callStatusText.textContent = 'Baƒülandƒ±';
                    break;
                case 'disconnected':
                    callStatusText.textContent = 'Baƒülantƒ± kesildi';
                    break;
                case 'failed':
                    callStatusText.textContent = 'Baƒülantƒ± ba≈üarƒ±sƒ±z';
                    break;
            }
        };
        
        console.log('Peer connection initialized');
        
    } catch (error) {
        console.error('Peer connection initialization failed:', error);
    }
}

// Send signaling message to admin
async function sendSignalingMessage(message) {
    try {
        const response = await fetch('/support/webrtc-signal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                message: message
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Signaling message failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending signaling message:', error);
    }
}

// Handle incoming signaling messages
async function handleSignalingMessage(message) {
    try {
        console.log('Handling signaling message:', message);
        
        switch (message.type) {
            case 'call-accepted':
                console.log('Call accepted by admin');
                callStatusText.textContent = 'Admin kabul etti, baƒülantƒ± kuruluyor...';
                
                // Create offer for admin
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send offer to admin
                await sendSignalingMessage({
                    type: 'offer',
                    sdp: offer
                });
                break;
                
            case 'admin-call-request':
                console.log('Admin video call request received');
                
                // Show admin call request notification
                showAdminCallRequest();
                break;
                
            case 'offer':
                console.log('Received offer from admin:', message);
                console.log('Offer SDP:', message.sdp);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                console.log('Remote description set successfully');
                
                // Create answer
                const answer = await peerConnection.createAnswer();
                console.log('Created answer:', answer);
                await peerConnection.setLocalDescription(answer);
                console.log('Local description set successfully');
                
                // Send answer to admin
                await sendSignalingMessage({
                    type: 'answer',
                    sdp: answer
                });
                console.log('Answer sent to admin');
                break;
                
            case 'answer':
                console.log('Received answer from admin:', message);
                console.log('Answer SDP:', message.sdp);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                console.log('Remote description updated with answer');
                break;
                
            case 'ice-candidate':
                console.log('Received ICE candidate from admin');
                if (message.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
                break;
                
            default:
                console.log('Unknown signaling message type:', message.type);
        }
    } catch (error) {
        console.error('Error handling signaling message:', error);
    }
}

// Show admin call request notification
function showAdminCallRequest() {
    // Create notification modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        ">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-video" style="font-size: 48px; color: #007bff; margin-bottom: 15px;"></i>
                <h4 style="color: #333; margin: 0;">Admin Video G√∂r√º≈üme ƒ∞stiyor</h4>
            </div>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                Destek temsilcisi sizinle g√∂r√ºnt√ºl√º g√∂r√º≈üme yapmak istiyor.
            </p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="acceptAdminCall()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 500;
                ">Kabul Et</button>
                <button onclick="rejectAdminCall()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 500;
                ">Reddet</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Store modal reference
    window.adminCallModal = modal;
}

// Admin video arama talebini kabul et
async function acceptAdminCall() {
    try {
        // Remove modal
        if (window.adminCallModal) {
            document.body.removeChild(window.adminCallModal);
            window.adminCallModal = null;
        }
        
        // Get user media
        const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        
        // Show local video
        document.getElementById('localVideo').srcObject = stream;
        document.getElementById('localVideo').style.display = 'block';
        
        // Show video call area
        document.getElementById('videoCallArea').style.display = 'block';
        document.getElementById('videoCallControls').style.display = 'flex';
        document.getElementById('startVideoCallBtn').style.display = 'none';
        
        // Adjust chat area height
        document.getElementById('chatMessages').style.height = '300px';
        
        isCallActive = true;
        document.getElementById('callStatusText').textContent = 'Video g√∂r√º≈üme ba≈ülatƒ±lƒ±yor...';
        
        // Initialize WebRTC peer connection
        await initializePeerConnection();
        
        // Add local stream to peer connection
        stream.getTracks().forEach(track => {
            peerConnection.addTrack(track, stream);
        });
        
        // Start signaling polling
        startSignalingPolling();
        
        console.log('‚úÖ Video call accepted and started');
        
        // Send acceptance to admin
        await sendSignalingMessage({
            type: 'call-accepted'
        });
        
        // Update video call request status
        await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'accept'
            })
        });
        
    } catch (error) {
        console.error('Error accepting admin call:', error);
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            alert('Kamera ve mikrofon eri≈üimi saƒülanamadƒ±. L√ºtfen izinleri kontrol edin.');
        } else {
            alert('Video g√∂r√º≈üme ba≈ülatƒ±lamadƒ±: ' + error.message);
        }
        
        // Send rejection to admin
        try {
            await sendSignalingMessage({
                type: 'call-rejected'
            });
            
            // Update video call request status
            await fetch('/support/video-call-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionID,
                    action: 'reject'
                })
            });
        } catch (rejectError) {
            console.error('Error rejecting call:', rejectError);
        }
    }
}

// Admin video arama talebini reddet
async function rejectAdminCall() {
    try {
        // Remove modal
        if (window.adminCallModal) {
            document.body.removeChild(window.adminCallModal);
            window.adminCallModal = null;
        }
        
        // Send rejection to admin
        await sendSignalingMessage({
            type: 'call-rejected'
        });
        
        // Update video call request status
        await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'reject'
            })
        });
        
    } catch (error) {
        console.error('Error rejecting admin call:', error);
    }
}

// Video arama talebi g√∂nder
async function sendVideoCallRequest() {
    try {
        // √ñnce mevcut video arama durumunu kontrol et
        const statusResponse = await fetch(`/support/video-call-status/${sessionID}`);
        const statusData = await statusResponse.json();
        
        if (statusData.success && statusData.has_request) {
            alert('Zaten aktif bir video arama talebiniz var. L√ºtfen bekleyin.');
            return;
        }
        
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'start'
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call request failed:', data.error);
            alert('Video arama talebi g√∂nderilemedi: ' + data.error);
        } else {
            // Video arama butonunu devre dƒ±≈üƒ± bƒ±rak
            const videoCallBtn = document.getElementById('startVideoCallBtn');
            videoCallBtn.disabled = true;
            videoCallBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Arama g√∂nderiliyor...';
            
            // 30 saniye sonra butonu tekrar aktif et
            setTimeout(() => {
                videoCallBtn.disabled = false;
                videoCallBtn.innerHTML = '<i class="fas fa-video me-1"></i>Video Arama';
            }, 30000);
        }
    } catch (error) {
        console.error('Error sending video call request:', error);
        alert('Video arama talebi g√∂nderilemedi. L√ºtfen tekrar deneyin.');
    }
}

async function sendVideoCallEnd() {
    try {
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'end'
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call end failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending video call end:', error);
    }

}

// Show permission dialog with detailed instructions
function showPermissionDialog(message) {
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white;
        border-radius: 10px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    
    modal.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"></i>
            <h4 style="color: #333; margin: 0;">Kamera ve Mikrofon ƒ∞zni Gerekli</h4>
        </div>
        <div style="white-space: pre-line; line-height: 1.6; color: #666; margin-bottom: 20px;">
            ${message}
        </div>
        <div style="text-align: center;">
            <button onclick="closePermissionDialog()" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin-right: 10px;
            ">Anladƒ±m</button>
            <button onclick="retryVideoCall()" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            ">Tekrar Dene</button>
        </div>
    `;
    
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    
    // Store reference for closing
    window.permissionDialog = backdrop;
}

// Close permission dialog
function closePermissionDialog() {
    if (window.permissionDialog) {
        document.body.removeChild(window.permissionDialog);
        window.permissionDialog = null;
    }
}

// Retry video call
function retryVideoCall() {
    closePermissionDialog();
    startVideoCall();
}

// Check camera and microphone permissions
async function checkMediaPermissions() {
    try {
        // Detect mobile device and browser
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Enhanced WebRTC support check for Safari
        const hasWebRTC = !!(window.RTCPeerConnection || 
                           window.webkitRTCPeerConnection || 
                           window.mozRTCPeerConnection ||
                           window.RTCPeerConnection);
        
        if (!hasWebRTC) {
            return {
                supported: false,
                message: `Bu tarayƒ±cƒ± WebRTC video g√∂r√º≈üme teknolojisini desteklemiyor.\n\n${isSafari ? 'üçé Safari i√ßin:\n‚Ä¢ Safari 11+ s√ºr√ºm√º gereklidir\n‚Ä¢ iOS 11+ veya macOS High Sierra+\n‚Ä¢ Tarayƒ±cƒ±nƒ±zƒ± g√ºncelleyin' : '‚Ä¢ Chrome, Firefox veya Edge kullanmayƒ± deneyin'}`
            };
        }
        
        // Enhanced getUserMedia support check with Safari-specific fallbacks
        const hasGetUserMedia = !!(
            (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) || 
            navigator.getUserMedia || 
            navigator.webkitGetUserMedia || 
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia
        );
        
        if (!hasGetUserMedia) {
            return {
                supported: false,
                message: `Bu tarayƒ±cƒ± kamera ve mikrofon eri≈üimini desteklemiyor.\n\n${isSafari ? 'üçé Safari g√ºncellemesi gerekli:\n‚Ä¢ Safari 11+ s√ºr√ºm√º kullanƒ±n\n‚Ä¢ iOS ayarlarƒ±ndan Safari\'yi g√ºncelleyin' : '‚Ä¢ Tarayƒ±cƒ±nƒ±zƒ± g√ºncelleyin veya farklƒ± tarayƒ±cƒ± deneyin'}`
            };
        }
        
        // Check if site is secure (HTTPS or localhost or local IP)
        const isSecure = location.protocol === 'https:' || 
                        location.hostname === 'localhost' || 
                        location.hostname === '127.0.0.1' ||
                        location.hostname.startsWith('192.168.') ||
                        location.hostname.startsWith('10.') ||
                        location.hostname.startsWith('172.') ||
                        location.hostname.endsWith('.local');
        
        // HTTPS requirement - more lenient for local network
        if (!isSecure && !location.hostname.startsWith('192.168.')) {
            return {
                supported: false,
                message: `G√ºvenli baƒülantƒ± gerekli.\n\n${isIOS ? 'üì± iOS Safari i√ßin:\n‚Ä¢ HTTPS baƒülantƒ±sƒ± zorunludur\n‚Ä¢ Yerel test i√ßin: http://192.168.x.x:9394 kullanƒ±n' : 'üîí G√ºvenlik gereksinimleri:\n‚Ä¢ HTTPS baƒülantƒ±sƒ± gereklidir\n‚Ä¢ Yerel aƒü IP\'si ile test edebilirsiniz'}`
            };
        }
        
        // Safari-specific constraints
        const constraints = {
            video: isSafari ? {
                facingMode: isMobile ? 'user' : 'environment',
                width: { ideal: isMobile ? 640 : 1280, max: 1920 },
                height: { ideal: isMobile ? 480 : 720, max: 1080 },
                frameRate: { ideal: 30, max: 30 }
            } : (isMobile ? { 
                facingMode: 'user',
                width: { ideal: 640 },
                height: { ideal: 480 }
            } : true),
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 44100
            }
        };
        
        // Try modern API first with Safari-specific handling
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                stream.getTracks().forEach(track => track.stop());
                return { supported: true, granted: true };
            } catch (error) {
                // Safari sometimes needs simpler constraints
                if (isSafari) {
                    try {
                        const simpleConstraints = { video: true, audio: true };
                        const stream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
                        stream.getTracks().forEach(track => track.stop());
                        return { supported: true, granted: true };
                    } catch (simpleError) {
                        return {
                            supported: true,
                            granted: false,
                            error: simpleError.name,
                            message: getSafariErrorMessage(simpleError.name, isIOS)
                        };
                    }
                } else {
                    return {
                        supported: true,
                        granted: false,
                        error: error.name,
                        message: getErrorMessage(error.name, isMobile)
                    };
                }
            }
        }
        
        // Fallback for older browsers with Promise wrapper
        return new Promise((resolve) => {
            const getUserMedia = navigator.getUserMedia || 
                               navigator.webkitGetUserMedia || 
                               navigator.mozGetUserMedia ||
                               navigator.msGetUserMedia;
            
            if (!getUserMedia) {
                resolve({
                    supported: false,
                    message: 'getUserMedia desteklenmiyor'
                });
                return;
            }
            
            getUserMedia.call(navigator, constraints,
                (stream) => {
                    stream.getTracks().forEach(track => track.stop());
                    resolve({ supported: true, granted: true });
                },
                (error) => {
                    resolve({ 
                        supported: true, 
                        granted: false, 
                        error: error.name,
                        message: isSafari ? getSafariErrorMessage(error.name, isIOS) : getErrorMessage(error.name, isMobile)
                    });
                }
            );
        });
        
    } catch (error) {
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        return {
            supported: true,
            granted: false,
            error: error.name,
            message: isSafari ? getSafariErrorMessage(error.name, isIOS) : getErrorMessage(error.name, false)
        };
    }
}

// Safari-specific error messages
function getSafariErrorMessage(errorName, isIOS) {
    const deviceInfo = isIOS ? 'iOS Safari' : 'Safari';
    
    switch (errorName) {
        case 'NotAllowedError':
            return `${deviceInfo} izinleri reddedildi.\n\n` +
                   `${isIOS ? 
                     'üì± iPhone/iPad i√ßin:\n‚Ä¢ Safari ayarlarƒ±na gidin\n‚Ä¢ "Kamera" ve "Mikrofon" b√∂l√ºm√ºnden bu siteye izin verin\n‚Ä¢ Sayfa adresinin yanƒ±ndaki "AA" simgesine tƒ±klayƒ±n\n‚Ä¢ "Website Ayarlarƒ±" > "Kamera ve Mikrofon" > "ƒ∞zin Ver"\n‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin' :
                     'üñ•Ô∏è Mac Safari i√ßin:\n‚Ä¢ Adres √ßubuƒüundaki kamera simgesine tƒ±klayƒ±n\n‚Ä¢ "ƒ∞zin ver" se√ßeneƒüini se√ßin\n‚Ä¢ Safari > Tercihler > Web Siteleri > Kamera/Mikrofon\n‚Ä¢ Bu siteye izin verin'
                   }`;
        case 'NotFoundError':
            return `Kamera veya mikrofon bulunamadƒ±.\n\n‚Ä¢ ${isIOS ? 'iPhone/iPad' : 'Mac'} cihazƒ±nda kamera ve mikrofon olduƒüundan emin olun\n‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lmƒ±yor olabilir\n‚Ä¢ ${isIOS ? 'iOS ayarlarƒ±ndan kamera/mikrofon izinlerini kontrol edin' : 'Sistem tercihlerinden kamera/mikrofon izinlerini kontrol edin'}`;
        case 'NotReadableError':
            return `Kamera veya mikrofon kullanƒ±mda.\n\n‚Ä¢ Ba≈üka bir Safari sekmesi veya uygulama kullanƒ±yor olabilir\n‚Ä¢ ${isIOS ? 'Uygulamayƒ± kapatƒ±p tekrar a√ßƒ±n' : 'Safari\'yi yeniden ba≈ülatƒ±n'}\n‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin`;
        case 'OverconstrainedError':
            return `Kamera ayarlarƒ± desteklenmiyor.\n\n‚Ä¢ Safari\'nin kamera kƒ±sƒ±tlamalarƒ± nedeniyle\n‚Ä¢ Farklƒ± bir kamera kullanmayƒ± deneyin\n‚Ä¢ Basit video ayarlarƒ± deneniyor...`;
        case 'SecurityError':
            return `Safari g√ºvenlik hatasƒ±.\n\n‚Ä¢ HTTPS baƒülantƒ±sƒ± gerekli\n‚Ä¢ ${isIOS ? 'iOS 11.3+ gerekli' : 'macOS High Sierra+ gerekli'}\n‚Ä¢ Safari s√ºr√ºm√ºn√ºz√º g√ºncelleyin\n‚Ä¢ Yerel test i√ßin: http://192.168.x.x:9394`;
        case 'AbortError':
            return `ƒ∞≈ülem iptal edildi.\n\n‚Ä¢ Safari tarafƒ±ndan durduruldu\n‚Ä¢ Tekrar deneyiniz\n‚Ä¢ Sayfayƒ± yenileyin`;
        default:
            return `Safari hatasƒ±: ${errorName}\n\n‚Ä¢ Safari s√ºr√ºm√ºn√ºz√º g√ºncelleyin\n‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin\n‚Ä¢ ${isIOS ? 'iOS 11.3+' : 'macOS High Sierra+'} gerekli\n‚Ä¢ Chrome veya Firefox deneyebilirsiniz`;
    }
}

// Get user-friendly error message
function getErrorMessage(errorName, isMobile) {
    const deviceType = isMobile ? 'Mobil cihaz' : 'Tarayƒ±cƒ±';
    
    switch (errorName) {
        case 'NotAllowedError':
            return `${deviceType} izinleri reddedildi.\n\n` +
                   `${isMobile ? 
                     'üì± Mobil i√ßin:\n‚Ä¢ Tarayƒ±cƒ± ayarlarƒ±ndan siteye kamera/mikrofon izni verin\n‚Ä¢ Sayfa adresinin yanƒ±ndaki kilit simgesine tƒ±klayƒ±n\n‚Ä¢ "Kamera" ve "Mikrofon" se√ßeneklerini "ƒ∞zin ver" yapƒ±n' :
                     'üñ•Ô∏è Masa√ºst√º i√ßin:\n‚Ä¢ Adres √ßubuƒüundaki kamera simgesine tƒ±klayƒ±n\n‚Ä¢ "ƒ∞zin ver" se√ßeneƒüini se√ßin\n‚Ä¢ Sayfayƒ± yenileyin'
                   }`;
        case 'NotFoundError':
            return `Kamera veya mikrofon bulunamadƒ±.\n\n‚Ä¢ Cihazƒ±nƒ±zda kamera ve mikrofon olduƒüundan emin olun\n‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lmƒ±yor olabilir`;
        case 'NotReadableError':
            return `Kamera veya mikrofon kullanƒ±mda.\n\n‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor olabilir\n‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin`;
        case 'OverconstrainedError':
            return `Kamera ayarlarƒ± desteklenmiyor.\n\n‚Ä¢ Farklƒ± bir kamera kullanmayƒ± deneyin`;
        case 'SecurityError':
            return `G√ºvenlik hatasƒ±.\n\n‚Ä¢ HTTPS baƒülantƒ±sƒ± gerekli olabilir\n‚Ä¢ Tarayƒ±cƒ± ayarlarƒ±nƒ± kontrol edin`;
        default:
            return `Bilinmeyen hata: ${errorName}\n\n‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin\n‚Ä¢ Farklƒ± bir tarayƒ±cƒ± kullanmayƒ± deneyin`;
    }
}

// Update video call button based on permissions
async function updateVideoCallButton() {
    const permissions = await checkMediaPermissions();
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (!permissions.supported) {
        videoCallBtn.disabled = true;
        videoCallBtn.innerHTML = '<i class="fas fa-times"></i> Desteklenmiyor';
        videoCallBtn.title = permissions.message;
        
        // Add Safari-specific styling
        if (isSafari) {
            videoCallBtn.style.backgroundColor = '#ff6b6b';
            videoCallBtn.style.borderColor = '#ff6b6b';
        }
    } else if (!permissions.granted) {
        videoCallBtn.disabled = false;
        videoCallBtn.innerHTML = isSafari ? 
            `<i class="fas fa-video"></i> ${isIOS ? 'Safari ƒ∞zin Ver' : 'Safari G√∂r√º≈üme'}` :
            '<i class="fas fa-video"></i> ƒ∞zin Ver & G√∂r√ºnt√ºl√º G√∂r√º≈üme';
        videoCallBtn.title = permissions.message || 'Kamera ve mikrofon izni gerekli';
        
        // Add Safari-specific styling
        if (isSafari) {
            videoCallBtn.style.backgroundColor = '#007bff';
            videoCallBtn.style.borderColor = '#007bff';
            videoCallBtn.style.fontSize = '0.9em';
        }
    } else {
        videoCallBtn.disabled = false;
        videoCallBtn.innerHTML = isSafari ? 
            `<i class="fas fa-video"></i> ${isIOS ? 'iOS G√∂r√º≈üme' : 'Safari G√∂r√º≈üme'}` :
            '<i class="fas fa-video"></i> G√∂r√ºnt√ºl√º G√∂r√º≈üme';
        videoCallBtn.title = 'G√∂r√ºnt√ºl√º g√∂r√º≈üme ba≈ülat';
        
        // Add Safari success styling
        if (isSafari) {
            videoCallBtn.style.backgroundColor = '#28a745';
            videoCallBtn.style.borderColor = '#28a745';
        }
    }
    
    // Add Safari compatibility info
    if (isSafari && isIOS) {
        const safariInfo = document.createElement('small');
        safariInfo.style.display = 'block';
        safariInfo.style.color = '#6c757d';
        safariInfo.style.fontSize = '0.75em';
        safariInfo.style.marginTop = '5px';
        safariInfo.textContent = permissions.supported ? 
            (permissions.granted ? 'iOS Safari ‚úì' : 'iOS Safari - ƒ∞zin gerekli') :
            'iOS Safari desteklenmiyor';
        
        // Add info if not already exists
        const existingInfo = videoCallBtn.parentElement.querySelector('.safari-info');
        if (!existingInfo) {
            safariInfo.className = 'safari-info';
            videoCallBtn.parentElement.appendChild(safariInfo);
        }
    }
}

// Signaling polling
let signalingPollInterval;

function startSignalingPolling() {
    // Poll for signaling messages every 2 seconds (reduced frequency)
    signalingPollInterval = setInterval(async () => {
        if (sessionID) { // Always poll if sessionID exists to catch admin call requests
            await pollSignalingMessages();
        }
    }, 2000); // 2 saniye - daha az sƒ±klƒ±kta
}

function stopSignalingPolling() {
    if (signalingPollInterval) {
        clearInterval(signalingPollInterval);
        signalingPollInterval = null;
    }
}

async function pollSignalingMessages() {
    try {
        const response = await fetch(`/support/webrtc-signals/${sessionID}`);
        const data = await response.json();
        
        if (data.success && data.messages && data.messages.length > 0) {
            console.log('Received signaling messages:', data.messages); // Debug log
            for (const message of data.messages) {
                await handleSignalingMessage(message);
            }
        }
    } catch (error) {
        console.error('Error polling signaling messages:', error);
        // Stop polling on error to prevent spam
        stopSignalingPolling();
    }
}

// Session ba≈ülatma fonksiyonu
async function initializeSession() {
    try {
        // Session'ƒ± sunucuda aktif hale getir
        const response = await fetch('/support/ping', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                username: 'Ziyaret√ßi'
            })
        });
        
        if (response.ok) {
            console.log('Session ba≈üarƒ±yla ba≈ülatƒ±ldƒ±:', sessionID);
        } else {
            console.error('Session ba≈ülatƒ±lamadƒ±');
        }
    } catch (error) {
        console.error('Session ba≈ülatma hatasƒ±:', error);
    }
}

// Sayfa y√ºklendiƒüinde session'ƒ± ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    // Session ID'yi olu≈ütur veya mevcut olanƒ± al
    if (!sessionID) {
        sessionID = generateSessionID();
        console.log('Yeni session olu≈üturuldu:', sessionID);
    }
    
    // Session'ƒ± aktif hale getir
    initializeSession();
    
    // Ping g√∂nder
    sendPing();
    
    // Ping interval'ƒ±nƒ± ba≈ülat
    startPingInterval();
    
    // Cart count interval'ƒ±nƒ± ba≈ülat
    startCartInterval();
    
    // Signaling polling'i ba≈ülat
    startSignalingPolling();
    
    console.log('Support chat sayfasƒ± ba≈ülatƒ±ldƒ± - Session:', sessionID);
});
</script>
{{end}} 