{{template "base.html" .}}

{{define "content"}}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Video Call Area - Admin Panelindeki T√ºm √ñzellikler -->
            <div id="videoCallArea" class="video-call-area mb-3" style="display: none; height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; border-radius: 0; overflow: hidden; box-shadow: none; margin: 0; padding: 0; border: none; outline: none; border: none !important; box-shadow: none !important;">
                
                <!-- Ana Video (Admin/Ziyaret√ßi) -->
                <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; border-radius: 0; border: none; box-shadow: none; outline: none;"></video>
                
                <!-- K√º√ß√ºk Video (Ziyaret√ßi) - Saƒü √úst K√∂≈üe -->
                <div class="pip-container" style="position: absolute; top: 15px; right: 15px; z-index: 10; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: all 0.3s ease; cursor: move; width: 200px; height: 150px; min-width: 200px; min-height: 150px; max-width: 200px; max-height: 150px; pointer-events: auto; border: none; outline: none;" id="pipContainer">
                    <video id="localVideo" autoplay style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: none; outline: none; transform: scaleX(-1);"></video>
                </div>
                
                <!-- T√ºm Kontroller (Sol Alt Taraf) -->
                <div class="left-controls" style="position: absolute; bottom: 15px; left: 15px; z-index: 15; display: flex; flex-direction: column; gap: 10px;">
                    <button id="microphoneBtn" class="btn btn-warning btn-lg" title="Mikrofon" style="border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(255, 193, 7, 0.95); border: 2px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <i class="fas fa-microphone" style="font-size: 20px; color: white;"></i>
                    </button>
                    
                    <button id="switchCameraBtn" class="btn btn-info btn-lg" title="Kamera Deƒüi≈ütir" style="border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(23, 162, 184, 0.95); border: 2px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <i class="fas fa-sync-alt" style="font-size: 20px; color: white;"></i>
                    </button>

                    <button id="toggleVideoBtn" class="btn btn-secondary btn-lg" title="Kamerayƒ± A√ß/Kapat" style="border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(108, 117, 125, 0.9); border: 2px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <i class="fas fa-video" style="font-size: 20px; color: white;"></i>
                    </button>
                    <button id="endCallBtn" class="btn btn-danger btn-lg" title="G√∂r√º≈ümeyi Sonlandƒ±r" style="border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(220, 53, 69, 0.9); border: 2px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <i class="fas fa-phone-slash" style="font-size: 20px; color: white;"></i>
                    </button>
                </div>
                

                
                <!-- Durum G√∂stergesi -->
                <div class="call-status" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 20px; font-size: 13px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); z-index: 50;">
                    <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                    <span id="callStatusText">Baƒülantƒ± kuruluyor...</span>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex flex-column align-items-start">
                        <div class="w-100 mb-2">
                            <h4 class="mb-0">
                                <i class="fas fa-comments me-2"></i>Canlƒ± Destek
                            </h4>
                            <small>Sorularƒ±nƒ±z i√ßin 7/24 buradayƒ±z!</small>
                        </div>
                        <div class="w-100">
                            <button id="videoCallBtn" class="btn btn-success btn-lg" title="G√∂r√ºnt√ºl√º G√∂r√º≈ümeye Ge√ß" style="font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.3); animation: pulse-glow 2s infinite;">
                                <i class="fas fa-video me-2"></i>üìû G√∂r√ºnt√ºl√º G√∂r√º≈üme
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Chat Messages Area -->
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Merhaba! Size nasƒ±l yardƒ±mcƒ± olabiliriz?</p>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="chat-input border-top p-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." maxlength="500">
                            <button class="btn btn-primary" id="sendButton" type="button">
                                <i class="fas fa-paper-plane"></i> G√∂nder
                            </button>
                        </div>
                        <small class="text-muted">Enter tu≈üuna basarak da mesaj g√∂nderebilirsiniz</small>
                    </div>
                </div>
            </div>
            
            <!-- Support Info -->
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Destek Saatleri:</strong> 7/24 online destek hizmeti veriyoruz. 
                Mesajlarƒ±nƒ±z en kƒ±sa s√ºrede yanƒ±tlanacaktƒ±r.
            </div>
            
            <!-- Safari Compatibility Info -->
            <div id="safariInfo" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-safari me-2"></i>
                <strong>Safari Kullanƒ±cƒ±larƒ± ƒ∞√ßin:</strong>
                <ul class="mb-0 mt-2">
                    <li>iOS 11.3+ veya macOS High Sierra+ gereklidir</li>
                    <li>Kamera ve mikrofon izni vermeniz gerekecek</li>
                    <li>Yerel aƒüda test i√ßin: <code>https://192.168.1.133:8081</code></li>
                    <li>Sorun ya≈üarsanƒ±z Chrome veya Firefox deneyebilirsiniz</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user {
    text-align: right;
}

.message.admin {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.admin .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}

.message.user .message-time {
    text-align: right;
    color: #fff;
}

.message.admin .message-time {
    text-align: left;
    color: #666;
}

.typing-indicator {
    text-align: left;
    margin-bottom: 15px;
}

.typing-bubble {
    display: inline-block;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 18px;
    padding: 12px 16px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.chat-input {
    background: white;
}

#messageInput:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Video Call Styles */
.video-call-area {
    border: none !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    overflow: visible !important; /* Butonlarƒ±n dƒ±≈üarƒ± √ßƒ±kmasƒ±na izin ver */
}

/* Video Call Button Animation */
@keyframes pulse-glow {
    0% {
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.6);
        transform: scale(1.05);
    }
    100% {
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transform: scale(1);
    }
}

#videoCallBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(40, 167, 69, 0.8);
    transition: all 0.3s ease;
}

.video-controls {
    display: flex !important;
    flex-direction: row !important;
    gap: 10px;
    align-items: center;
    justify-content: center;
}

.video-controls button {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-controls button.muted {
    background-color: #dc3545;
    border-color: #dc3545;
}

.video-controls button.video-off {
    background-color: #dc3545;
    border-color: #dc3545;
}



#localVideo {
    cursor: pointer;
    transition: all 0.3s ease;
}

#localVideo:hover {
    transform: scale(1.05);
}

.call-status {
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
}

/* Responsive Video Kontrolleri */
@media (max-width: 768px) {
    /* Video call area mobilde daha y√ºksek */
    .video-call-area {
        margin-left: -15px !important;
        margin-right: -15px !important;
        border-radius: 0 !important;
        width: calc(100% + 30px) !important;
        height: 60vh !important; /* Ekranƒ±n %60'ƒ± kadar y√ºkseklik */
        min-height: 300px !important;
    }
    
    /* Mobil cihazlarda masa√ºst√º kontrollerini g√∂ster */
    .left-controls {
        display: flex !important;
        position: fixed !important; /* Fixed position kullan */
        bottom: 15px !important;
        left: 10px !important;
        z-index: 9999 !important; /* √áok y√ºksek z-index */
        flex-direction: column !important;
        gap: 10px !important;
        background: rgba(0,0,0,0.9) !important;
        padding: 10px !important;
        border-radius: 15px !important;
        backdrop-filter: blur(10px) !important;
        border: 1px solid rgba(255,255,255,0.2) !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.5) !important;
    }
    
    /* Kamera deƒüi≈ütirme butonunu mobilde g√∂ster */
    .mobile-only {
        display: block !important;
        position: fixed !important; /* Fixed position kullan */
        top: 10px !important;
        left: 10px !important;
        z-index: 9999 !important;
    }
    
    /* Mobil buton hover efektleri */
    .mobile-control:active {
        transform: scale(0.95);
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    
    #switchCameraBtn {
        display: block !important;
        visibility: visible !important;
    }
    
    #switchCameraBtn:active {
        transform: rotate(180deg) scale(0.95);
    }
    
    /* √áok b√ºy√ºk video ve √ßer√ßeve */
    #localVideo {
        width: 300px !important;
        height: 225px !important;
        top: 10px !important;
        right: 10px !important;
        border-radius: 18px !important;
    }
    
    /* Ana video tam boyut */
    #remoteVideo {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
    }
    
    .video-call-area {
        height: 400px !important;
    }
    
    .chat-messages {
        height: 200px !important;
    }
    
    .remote-video-responsive {
        position: absolute !important;
        top: 15px !important;
        right: 15px !important;
        width: 120px !important;
        height: 90px !important;
        object-fit: cover !important;
        border-radius: 10px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4) !important;
        z-index: 30 !important;
    }
}

@media (min-width: 769px) {
    /* Masa√ºst√ºnde kontroller normal pozisyonda */
    .left-controls {
        position: absolute !important;
        bottom: 15px !important;
        left: 15px !important;
        background: transparent !important;
        padding: 0 !important;
        box-shadow: none !important;
    }
    
    /* Masa√ºst√º kontrollerini g√∂ster */
    .desktop-controls {
        display: flex !important;
    }
    
    /* Kamera deƒüi≈ütirme butonunu masa√ºst√ºnde gizle */
    .mobile-only {
        display: none !important;
        visibility: hidden !important;
    }
}

/* Buton Durumlarƒ± - Geli≈ütirilmi≈ü */
.mobile-control.muted,
.btn-secondary.muted {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    animation: pulse-red 1.5s infinite;
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.6) !important;
}

.mobile-control.video-off,
.btn-secondary.video-off {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.6) !important;
}

@keyframes pulse-red {
    0%, 100% { 
        opacity: 1; 
        transform: scale(1);
    }
    50% { 
        opacity: 0.8; 
        transform: scale(1.05);
    }
}

/* Kamera deƒüi≈ütirme butonu animasyonu - Geli≈ütirilmi≈ü */
#switchCameraBtn {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

#switchCameraBtn:active {
    transform: rotate(180deg) scale(0.9);
}

#switchCameraBtn:hover {
    background: rgba(23, 162, 184, 1) !important;
    box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
    transform: scale(1.1);
}

/* Safari-specific styles */
@supports (-webkit-appearance: none) {
    #localVideo, #remoteVideo {
        -webkit-playsinline: true;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);  /* Modern tarayƒ±cƒ±lar i√ßin ekleyin */
        backface-visibility: hidden;
    }
    
    .video-call-area {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
    
    #videoCallBtn {
        -webkit-appearance: none;
        appearance: none;  /* Modern tarayƒ±cƒ±lar i√ßin ekleyin */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        backface-visibility: hidden;
        border-radius: 6px;
    }
}

/* iOS Safari specific */
@supports (-webkit-touch-callout: none) {
    .video-controls {
        padding-bottom: 20px; /* Account for iOS home indicator */
    }
    
    .chat-input {
        padding-bottom: 25px; /* Account for iOS keyboard */
    }
    
    #messageInput {
        font-size: 16px; /* Prevent zoom on iOS */
    }
}

#remoteVideo::-webkit-media-controls-start-playback-button {
  display: none !important;
}
#remoteVideo::-webkit-media-controls-overlay-play-button {
  display: none !important;
}
#remoteVideo::-webkit-media-controls-panel {
  display: none !important;
}
#remoteVideo::-webkit-media-controls {
  display: none !important;
}
#remoteVideo::-webkit-media-controls-enclosure {
  display: none !important;
}
</style>

<script>
let sessionID = '{{.sessionID}}';
let lastMessageTime = null;
let pollInterval;

// SessionID'yi d√∂nd√ºren fonksiyon
function getSessionID() {
    return sessionID;
}

// Video Call Variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isCallActive = false;
let isVideoOff = false;
let isMicrophoneOff = false;
let videoCallRequested = false; // Video call talebi g√∂nderildi mi?

// DOM Elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const videoCallBtn = document.getElementById('videoCallBtn');
const videoCallArea = document.getElementById('videoCallArea');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const toggleMuteBtn = document.getElementById('toggleMuteBtn');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const callStatusText = document.getElementById('callStatusText');

// Interval ID'lerini sakla
let webrtcInterval;
let pingInterval;
let cartInterval;

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, session ID:', sessionID);
    
    // Session ID yoksa olu≈ütur
    if (!sessionID || sessionID === '') {
        sessionID = generateSessionID();
        console.log('Generated new session ID:', sessionID);
        // Cookie'ye kaydet
        document.cookie = `user_session=${sessionID}; path=/; max-age=${3600*24*30}`;
    }
    
    // Video call butonunu aktif et
    if (videoCallBtn) {
        videoCallBtn.style.display = 'block';
        videoCallBtn.addEventListener('click', sendVideoCallRequest);
    }
    
    // ƒ∞lk ping'i hemen g√∂nder
    fetch('/support/ping', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Initial ping sent successfully');
        }
    })
    .catch(error => {
        console.error('Initial ping error:', error);
    });
    
    loadMessages();
    startPolling();
    
    // Start signaling polling for incoming admin calls
    startSignalingPolling();
    
    // Check video call permissions on load
    updateVideoCallButton();
    
    // Show Safari info if using Safari
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isSafari) {
        const safariInfo = document.getElementById('safariInfo');
        if (safariInfo) {
            safariInfo.style.display = 'block';
        }
    }
    
    // Send message on button click
    sendButton.addEventListener('click', sendMessage);
    
    // Send message on Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Focus on input
    messageInput.focus();
    
    // Admin Panelindeki Event Listeners
    videoCallBtn.addEventListener('click', startVideoCall);
    
    // Video call kontrolleri
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const microphoneBtn = document.getElementById('microphoneBtn');
    
    if (toggleVideoBtn) {
        toggleVideoBtn.addEventListener('click', toggleVideo);
    }
    if (switchCameraBtn) {
        switchCameraBtn.addEventListener('click', switchCamera);
    }
    if (endCallBtn) {
        endCallBtn.addEventListener('click', endVideoCall);
    }
    if (microphoneBtn) {
        microphoneBtn.addEventListener('click', toggleMicrophone);
    }
    
    // Sayfa ilk a√ßƒ±ldƒ±ƒüƒ±nda G√∂r√ºnt√ºl√º Ara butonunu g√∂r√ºn√ºr yap
    videoCallBtn.style.display = 'inline-block';
    
    // Sayfa y√ºklendiƒüinde periyodik olarak sunucuya ping at
    pingInterval = setInterval(function() {
        fetch('/support/ping', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Ping sent successfully (page visible)');
            }
        })
        .catch(error => {
            console.error('Ping error (page visible):', error);
        });
    }, 15000); // 15 saniye
    

    
    // Admin Panelindeki PIP Container Drag & Drop
    const pipContainer = document.getElementById('pipContainer');
    if (pipContainer) {
        let isDragging = false;
        let startX, startY, startLeft, startTop;
        
        pipContainer.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(pipContainer.style.left) || 15;
            startTop = parseInt(pipContainer.style.top) || 15;
            pipContainer.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            const newLeft = startLeft + deltaX;
            const newTop = startTop + deltaY;
            
            // Video call area sƒ±nƒ±rlarƒ± i√ßinde tut
            const videoCallArea = document.getElementById('videoCallArea');
            const maxLeft = videoCallArea.offsetWidth - pipContainer.offsetWidth - 15;
            const maxTop = videoCallArea.offsetHeight - pipContainer.offsetHeight - 15;
            
            pipContainer.style.left = Math.max(15, Math.min(newLeft, maxLeft)) + 'px';
            pipContainer.style.top = Math.max(15, Math.min(newTop, maxTop)) + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
            pipContainer.style.cursor = 'move';
        });
        
        // Touch events for mobile
        pipContainer.addEventListener('touchstart', function(e) {
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startLeft = parseInt(pipContainer.style.left) || 15;
            startTop = parseInt(pipContainer.style.top) || 15;
        });
        
        document.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const deltaX = e.touches[0].clientX - startX;
            const deltaY = e.touches[0].clientY - startY;
            
            const newLeft = startLeft + deltaX;
            const newTop = startTop + deltaY;
            
            const videoCallArea = document.getElementById('videoCallArea');
            const maxLeft = videoCallArea.offsetWidth - pipContainer.offsetWidth - 15;
            const maxTop = videoCallArea.offsetHeight - pipContainer.offsetHeight - 15;
            
            pipContainer.style.left = Math.max(15, Math.min(newLeft, maxLeft)) + 'px';
            pipContainer.style.top = Math.max(15, Math.min(newTop, maxTop)) + 'px';
        });
        
        document.addEventListener('touchend', function() {
            isDragging = false;
        });
    }
});

function generateSessionID() {
    return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// Load existing messages
function loadMessages() {
    fetch('/support/messages', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.messages);
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

// Send message
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    fetch('/support/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            addMessage(data.message);
            scrollToBottom();
        } else {
            alert('Mesaj g√∂nderilemedi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Mesaj g√∂nderilirken hata olu≈ütu');
    })
    .finally(() => {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    });
}

// Display messages
function displayMessages(messages) {
    // Clear loading message
    chatMessages.innerHTML = '';
    
    if (messages && messages.length > 0) {
        messages.forEach(message => {
            addMessage(message);
        });
        scrollToBottom();
    } else {
        showWelcomeMessage();
    }
}

// Add single message
function addMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_admin ? 'admin' : 'user'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.textContent = message.message;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    const messageTime = new Date(message.created_at);
    timeDiv.textContent = messageTime.toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    chatMessages.appendChild(messageDiv);
    
    // Update last message time
    lastMessageTime = message.created_at;
}

// Show welcome message
function showWelcomeMessage() {
    chatMessages.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <p>Merhaba! Size nasƒ±l yardƒ±mcƒ± olabiliriz?</p>
        </div>
    `;
}

// Scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Start polling for new messages
function startPolling() {
    pollInterval = setInterval(() => {
        loadMessages();
    }, 3000); // Poll every 3 seconds
}

// Sayfa g√∂r√ºn√ºrl√ºƒü√º deƒüi≈ütiƒüinde
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Sayfa gizlendiƒüinde T√úM interval'larƒ± durdur
        if (webrtcInterval) {
            clearInterval(webrtcInterval);
            webrtcInterval = null;
        }
        if (pingInterval) {
            clearInterval(pingInterval);
            pingInterval = null;
        }
        if (cartInterval) {
            clearInterval(cartInterval);
            cartInterval = null;
        }
        if (signalingPollInterval) {
            clearInterval(signalingPollInterval);
            signalingPollInterval = null;
        }
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
        // Sunucuya kullanƒ±cƒ±nƒ±n ayrƒ±ldƒ±ƒüƒ±nƒ± bildir
        navigator.sendBeacon('/support/leave');
        console.log('Sayfa gizlendi - T√ºm interval\'lar durduruldu');
    } else {
        // Sayfa tekrar g√∂r√ºn√ºr olduƒüunda hem ping hem de poll interval'ƒ±nƒ± yeniden ba≈ülat
        if (!pingInterval) {
            pingInterval = setInterval(function() {
                fetch('/support/ping', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Ping sent successfully (page visible)');
                    }
                })
                .catch(error => {
                    console.error('Ping error (page visible):', error);
                });
            }, 15000); // 15 saniye
        }
        if (!pollInterval) {
            pollInterval = setInterval(() => {
                loadMessages();
            }, 3000);
        }
        console.log('Sayfa g√∂r√ºn√ºr oldu - Ping ve poll interval yeniden ba≈ülatƒ±ldƒ±');
    }
});

// Sayfa kapatƒ±ldƒ±ƒüƒ±nda veya kullanƒ±cƒ± ayrƒ±ldƒ±ƒüƒ±nda
window.addEventListener('beforeunload', function() {
    try {
        navigator.sendBeacon('/support/leave');
    } catch(e) {
        // Hata sessizce yakalanƒ±r
    }
});

// Video Call Functions - Admin Panelindeki T√ºm √ñzellikler
async function startVideoCall() {
    try {
        console.log('Starting video call...');
        
        // Kamera ve mikrofon izni al
        localStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280, max: 1920 },
                height: { ideal: 720, max: 1080 },
                facingMode: 'user'
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        console.log('Local stream obtained:', localStream);
        
        // Ziyaret√ßinin videosunu k√º√ß√ºk pencereye yerle≈ütir
        document.getElementById('localVideo').srcObject = localStream;
        
        // Video alanƒ±nƒ± g√∂ster
        document.getElementById('videoCallArea').style.display = 'block';
        videoCallBtn.style.display = 'none';
        
        // WebRTC baƒülantƒ±sƒ±nƒ± ba≈ülat
        await initializePeerConnection();
        
        // Offer olu≈ütur ve admin'e g√∂nder
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        await sendSignalingMessage({ type: 'offer', sdp: offer });
        
        // Video call request g√∂nder
        await sendVideoCallRequest();
        
        isCallActive = true;
        callStatusText.textContent = 'Baƒülantƒ± kuruluyor...';
        
        // Start signaling polling
        startSignalingPolling();
        
    } catch (error) {
        console.error('Video call start error:', error);
        alert('Video g√∂r√º≈üme ba≈ülatƒ±lamadƒ±: ' + error.message);
        
        // Cleanup
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
    }
}

async function endVideoCall() {
    try {
        // Stream'leri durdur
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Peer connection'ƒ± kapat
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        // Video alanƒ±nƒ± gizle
        document.getElementById('videoCallArea').style.display = 'none';
        videoCallBtn.style.display = 'inline-block';
        
        // Video elementlerini temizle
        document.getElementById('localVideo').srcObject = null;
        document.getElementById('remoteVideo').srcObject = null;
        
        // Durumlarƒ± sƒ±fƒ±rla
        isCallActive = false;
        isMuted = false;
        isVideoOff = false;
        
        // Stop signaling polling
        stopSignalingPolling();
        
        // Send end call notification
        await sendVideoCallEnd();
        
    } catch (error) {
        console.error('Video call sonlandƒ±rma hatasƒ±:', error);
    }
}



function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        isVideoOff = !videoTrack.enabled;
        
        // Buton g√∂r√ºn√ºm√ºn√º g√ºncelle
        const videoBtn = document.getElementById('toggleVideoBtn');
        if (videoBtn) {
            if (isVideoOff) {
                videoBtn.innerHTML = '<i class="fas fa-video-slash" style="font-size: 20px; color: white;"></i>';
                videoBtn.style.background = 'rgba(220, 53, 69, 0.9)';
            } else {
                videoBtn.innerHTML = '<i class="fas fa-video" style="font-size: 20px; color: white;"></i>';
                videoBtn.style.background = 'rgba(108, 117, 125, 0.9)';
            }
        }
    }
}

function toggleMicrophone() {
    console.log('toggleMicrophone called');
    console.log('localStream:', localStream);
    
    if (localStream) {
        const audioTracks = localStream.getAudioTracks();
        console.log('Audio tracks:', audioTracks);
        
        if (audioTracks && audioTracks.length > 0) {
            const audioTrack = audioTracks[0];
            console.log('Audio track enabled before:', audioTrack.enabled);
            
            audioTrack.enabled = !audioTrack.enabled;
            isMicrophoneOff = !audioTrack.enabled;
            
            console.log('Audio track enabled after:', audioTrack.enabled);
            console.log('isMicrophoneOff:', isMicrophoneOff);
            
            // Buton g√∂r√ºn√ºm√ºn√º g√ºncelle
            const micBtn = document.getElementById('microphoneBtn');
            if (micBtn) {
                if (isMicrophoneOff) {
                    micBtn.innerHTML = '<i class="fas fa-microphone-slash" style="font-size: 20px; color: white;"></i>';
                    micBtn.style.background = 'rgba(220, 53, 69, 0.9)';
                    console.log('Microphone button: OFF');
                } else {
                    micBtn.innerHTML = '<i class="fas fa-microphone" style="font-size: 20px; color: white;"></i>';
                    micBtn.style.background = 'rgba(255, 193, 7, 0.95)';
                    console.log('Microphone button: ON');
                }
            }
        } else {
            console.error('No audio tracks found in localStream');
        }
    } else {
        console.error('localStream is null or undefined');
    }
}

// Admin Panelindeki Kamera Deƒüi≈ütirme Fonksiyonu
async function switchCamera() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        const currentFacingMode = videoTrack.getSettings().facingMode || 'user';
        const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        
        try {
            // Yeni stream al
            localStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: newFacingMode },
                audio: true
            });
            
            // Video elementini g√ºncelle
            document.getElementById('localVideo').srcObject = localStream;
            
            // Peer connection'daki track'i deƒüi≈ütir
            if (peerConnection) {
                const videoSender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (videoSender) {
                    await videoSender.replaceTrack(localStream.getVideoTracks()[0]);
                }
            }
        } catch (error) {
            console.error('Kamera deƒüi≈ütirme hatasƒ±:', error);
            alert('Kamera deƒüi≈ütirilemedi: ' + error.message);
        }
    }
}

// Mobil ve masa√ºst√º buton senkronizasyonu


// Initialize WebRTC Peer Connection
async function initializePeerConnection() {
    try {
        // Create peer connection with STUN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream to peer connection
        if (localStream) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }
        
        // Handle remote stream - D√úZELTME
        peerConnection.ontrack = (event) => {
            console.log('Received remote stream from admin:', event);
            if (event.streams && event.streams[0]) {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    console.log('Setting remote stream to video element');
                    remoteVideo.srcObject = event.streams[0];
                    
                    // Video metadata y√ºklendiƒüinde
                    remoteVideo.onloadedmetadata = () => {
                        console.log('Remote video metadata loaded');
                        console.log('Remote video dimensions:', remoteVideo.videoWidth, 'x', remoteVideo.videoHeight);
                        
                        // Video oynatmayƒ± ba≈ülat
                        remoteVideo.play().then(() => {
                            console.log('Remote video started playing');
                            callStatusText.textContent = 'Baƒülandƒ± - Video aktif';
                        }).catch(error => {
                            console.error('Error playing remote video:', error);
                            // Kullanƒ±cƒ± etkile≈üimi gerekebilir
                            remoteVideo.muted = true;
                            remoteVideo.play();
                        });
                    };
                    
                    // Video oynatma olaylarƒ±
                    remoteVideo.onplay = () => console.log('Remote video playing');
                    remoteVideo.onpause = () => console.log('Remote video paused');
                    remoteVideo.onerror = (error) => console.error('Remote video error:', error);
                    
                    // Video y√ºklenme durumu
                    remoteVideo.oncanplay = () => {
                        console.log('Remote video can play');
                        remoteVideo.play();
                    };
                } else {
                    console.error('Remote video element not found');
                }
            } else {
                console.error('No remote stream in track event');
            }
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignalingMessage({
                    type: 'ice-candidate',
                    candidate: event.candidate
                });
            }
        };
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
            console.log('Connection state:', peerConnection.connectionState);
            switch (peerConnection.connectionState) {
                case 'connected':
                    callStatusText.textContent = 'Baƒülandƒ±';
                    break;
                case 'disconnected':
                    callStatusText.textContent = 'Baƒülantƒ± kesildi';
                    break;
                case 'failed':
                    callStatusText.textContent = 'Baƒülantƒ± ba≈üarƒ±sƒ±z';
                    break;
            }
        };
        
        peerConnection.onsignalingstatechange = () => {
            console.log('Signaling state changed to:', peerConnection.signalingState);
        };
        
        console.log('Peer connection initialized');
        
    } catch (error) {
        console.error('Peer connection initialization failed:', error);
    }
}

// Send signaling message to admin
async function sendSignalingMessage(message) {
    try {
        const response = await fetch('/support/webrtc-signal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                message: message
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Signaling message failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending signaling message:', error);
    }
}

// Handle incoming signaling messages
async function handleSignalingMessage(message) {
    try {
        console.log('Handling signaling message:', message);
        
        switch (message.type) {
            case 'call-accepted':
                console.log('Call accepted by admin');
                callStatusText.textContent = 'Admin kabul etti, baƒülantƒ± kuruluyor...';
                
                // Create offer for admin
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send offer to admin
                await sendSignalingMessage({
                    type: 'offer',
                    sdp: offer
                });
                break;
                
            case 'admin-call-request':
                console.log('Admin video call request received');
                
                // Show admin call request notification
                showAdminCallRequest();
                break;
                
            case 'offer':
                console.log('Received offer from admin:', message);
                console.log('Offer SDP:', message.sdp);
                
                // Admin'den offer geldiƒüinde, √∂nce kendi stream'ini peer connection'a ekle
                if (localStream && !peerConnection) {
                    console.log('Initializing peer connection for admin call...');
                    await initializePeerConnection();
                }
                
                // D√úZELTME: Admin'den yeni offer geldiƒüinde remote description'ƒ± g√ºncelle
                try {
                    if (peerConnection.signalingState === 'stable') {
                        // Stable durumda, doƒürudan remote description'ƒ± ayarla
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    } else if (peerConnection.signalingState === 'have-local-offer') {
                        // Collision durumu - rollback yap
                        await peerConnection.setLocalDescription({type: 'rollback'});
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    } else {
                        // Diƒüer durumlar i√ßin bekle
                        console.log('Waiting for stable state, current:', peerConnection.signalingState);
                        await new Promise(resolve => {
                            const checkState = () => {
                                if (peerConnection.signalingState === 'stable') {
                                    resolve();
                                } else {
                                    setTimeout(checkState, 100);
                                }
                            };
                            checkState();
                        });
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    }
                    
                    console.log('Remote description set successfully');
                    
                    // Answer olu≈ütur ve g√∂nder
                    const answer = await peerConnection.createAnswer();
                    console.log('Created answer:', answer);
                    await peerConnection.setLocalDescription(answer);
                    console.log('Local description set successfully');
                    
                    // Answer'ƒ± admin'e g√∂nder
                    await sendSignalingMessage({
                        type: 'answer',
                        sdp: answer
                    });
                    console.log('Answer sent to admin');
                    
                } catch (error) {
                    console.error('Error handling offer:', error);
                    callStatusText.textContent = 'Baƒülantƒ± hatasƒ±';
                }
                break;
                
            case 'answer':
                console.log('Received answer from admin:', message);
                console.log('Answer SDP:', message.sdp);
                
                try {
                    if (peerConnection.signalingState === 'have-local-offer') {
                        // Normal durum - answer bekleniyor
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    } else if (peerConnection.signalingState === 'stable') {
                        console.log('Already in stable state, ignoring answer');
                        return;
                    } else {
                        // Diƒüer durumlar i√ßin bekle
                        console.log('Waiting for correct state for answer, current:', peerConnection.signalingState);
                        await new Promise(resolve => {
                            const checkState = () => {
                                if (peerConnection.signalingState === 'have-local-offer' || peerConnection.signalingState === 'stable') {
                                    resolve();
                                } else {
                                    setTimeout(checkState, 100);
                                }
                            };
                            checkState();
                        });
                        
                        if (peerConnection.signalingState === 'have-local-offer') {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                        }
                    }
                    console.log('Remote description updated with answer');
                } catch (error) {
                    console.error('Error setting remote description for answer:', error);
                }
                break;
                
            case 'ice-candidate':
                console.log('Received ICE candidate from admin');
                if (message.candidate && peerConnection && peerConnection.remoteDescription) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        console.log('ICE candidate added successfully');
                    } catch (error) {
                        console.error('Error adding ICE candidate:', error);
                    }
                } else if (message.candidate) {
                    console.log('Queuing ICE candidate until remote description is set');
                    // Store ICE candidates for later use when remote description is available
                    if (!window.queuedIceCandidates) {
                        window.queuedIceCandidates = [];
                    }
                    window.queuedIceCandidates.push(message.candidate);
                }
                break;
                
            default:
                console.log('Unknown signaling message type:', message.type);
        }
    } catch (error) {
        console.error('Error handling signaling message:', error);
    }
}

// Show admin call request notification
function showAdminCallRequest() {
    // Create notification modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        ">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-video" style="font-size: 48px; color: #007bff; margin-bottom: 15px;"></i>
                <h4 style="color: #333; margin: 0;">Admin Video G√∂r√º≈üme ƒ∞stiyor</h4>
            </div>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                Destek temsilcisi sizinle g√∂r√ºnt√ºl√º g√∂r√º≈üme yapmak istiyor.
            </p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="acceptAdminCall()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 500;
                ">Kabul Et</button>
                <button onclick="rejectAdminCall()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 500;
                ">Reddet</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Store modal reference
    window.adminCallModal = modal;
}

// Accept admin call
async function acceptAdminCall() {
    try {
        // Remove modal
        if (window.adminCallModal) {
            document.body.removeChild(window.adminCallModal);
            window.adminCallModal = null;
        }
    
        // Start video call
        await startVideoCall();
        
        // Send acceptance to admin
        await sendSignalingMessage({
            type: 'call-accepted'
        });
        
    } catch (error) {
        console.error('Error accepting admin call:', error);
        alert('Video g√∂r√º≈üme ba≈ülatƒ±lamadƒ±: ' + error.message);
    }
}

// Reject admin call
async function rejectAdminCall() {
    try {
        // Remove modal
        if (window.adminCallModal) {
            document.body.removeChild(window.adminCallModal);
            window.adminCallModal = null;
        }
        
        // Send rejection to admin
        await sendSignalingMessage({
            type: 'call-rejected'
        });
        
    } catch (error) {
        console.error('Error rejecting admin call:', error);
    }
}

async function sendVideoCallRequest() {
    try {
        console.log('=== SENDING VIDEO CALL REQUEST ===');
        console.log('Session ID:', sessionID);
        
        if (!sessionID) {
            console.error('Session ID is missing!');
            alert('Oturum bilgisi bulunamadƒ±. Sayfayƒ± yenileyin.');
            return;
        }
        
        const requestData = {
            session_id: sessionID,
            action: 'start'
        };
        console.log('Request data:', requestData);
        
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            console.log('Video call request successful');
            videoCallRequested = true;
            videoCallBtn.innerHTML = '<i class="fas fa-clock me-2"></i>Talep G√∂nderildi';
            videoCallBtn.disabled = true;
            
            // Sistem mesajƒ± ekle
            addMessage({
                message: 'üìû G√∂r√ºnt√ºl√º g√∂r√º≈üme talebi g√∂nderildi. Admin yanƒ±tƒ±nƒ± bekliyor...',
                is_admin: false,
                created_at: new Date().toISOString()
            });
        } else {
            console.error('Video call request failed:', data.error);
            // alert('Video call talebi g√∂nderilemedi: ' + (data.error || 'Bilinmeyen hata'));
        }
    } catch (error) {
        console.error('Error sending video call request:', error);
        // alert('Video call talebi g√∂nderilirken hata olu≈ütu: ' + error.message);
    }
}

async function sendVideoCallEnd() {
    try {
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'end'
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call end failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending video call end:', error);
    }
}

// Show permission dialog with detailed instructions
function showPermissionDialog(message) {
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white;
        border-radius: 10px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    
    modal.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"></i>
            <h4 style="color: #333; margin: 0;">Kamera ve Mikrofon ƒ∞zni Gerekli</h4>
        </div>
        <div style="white-space: pre-line; line-height: 1.6; color: #666; margin-bottom: 20px;">
            ${message}
        </div>
        <div style="text-align: center;">
            <button onclick="closePermissionDialog()" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin-right: 10px;
            ">Anladƒ±m</button>
            <button onclick="retryVideoCall()" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            ">Tekrar Dene</button>
        </div>
    `;
    
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    
    // Store reference for closing
    window.permissionDialog = backdrop;
}

// Close permission dialog
function closePermissionDialog() {
    if (window.permissionDialog) {
        document.body.removeChild(window.permissionDialog);
        window.permissionDialog = null;
    }
}

// Retry video call
function retryVideoCall() {
    closePermissionDialog();
    startVideoCall();
}

// Check camera and microphone permissions
async function checkMediaPermissions() {
    try {
        // Detect mobile device and browser
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Enhanced WebRTC support check for Safari
        const hasWebRTC = !!(window.RTCPeerConnection || 
                           window.webkitRTCPeerConnection || 
                           window.mozRTCPeerConnection ||
                           window.RTCPeerConnection);
        
        if (!hasWebRTC) {
            return {
                supported: false,
                message: `Bu tarayƒ±cƒ± WebRTC video g√∂r√º≈üme teknolojisini desteklemiyor.\n\n${isSafari ? 'üçé Safari i√ßin:\n‚Ä¢ Safari 11+ s√ºr√ºm√º gereklidir\n‚Ä¢ iOS 11+ veya macOS High Sierra+\n‚Ä¢ Tarayƒ±cƒ±nƒ±zƒ± g√ºncelleyin' : '‚Ä¢ Chrome, Firefox veya Edge kullanmayƒ± deneyin'}`
            };
        }
        
        // Enhanced getUserMedia support check with Safari-specific fallbacks
        const hasGetUserMedia = !!(
            (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) || 
            navigator.getUserMedia || 
            navigator.webkitGetUserMedia || 
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia
        );
        
        if (!hasGetUserMedia) {
            return {
                supported: false,
                message: `Bu tarayƒ±cƒ± kamera ve mikrofon eri≈üimini desteklemiyor.\n\n${isSafari ? 'üçé Safari g√ºncellemesi gerekli:\n‚Ä¢ Safari 11+ s√ºr√ºm√º kullanƒ±n\n‚Ä¢ iOS ayarlarƒ±ndan Safari\'yi g√ºncelleyin' : '‚Ä¢ Tarayƒ±cƒ±nƒ±zƒ± g√ºncelleyin veya farklƒ± tarayƒ±cƒ± deneyin'}`
            };
        }
        
        // Check if site is secure (HTTPS or localhost or local IP)
        const isSecure = location.protocol === 'https:' || 
                        location.hostname === 'localhost' || 
                        location.hostname === '127.0.0.1' ||
                        location.hostname.startsWith('192.168.') ||
                        location.hostname.startsWith('10.') ||
                        location.hostname.startsWith('172.') ||
                        location.hostname.endsWith('.local');
        
        // HTTPS requirement - more lenient for local network
        if (!isSecure && !location.hostname.startsWith('192.168.')) {
            return {
                supported: false,
                message: `G√ºvenli baƒülantƒ± gerekli.\n\n${isIOS ? 'üì± iOS Safari i√ßin:\n‚Ä¢ HTTPS baƒülantƒ±sƒ± zorunludur\n‚Ä¢ Yerel test i√ßin: http://192.168.x.x:9394 kullanƒ±n' : 'üîí G√ºvenlik gereksinimleri:\n‚Ä¢ HTTPS baƒülantƒ±sƒ± gereklidir\n‚Ä¢ Yerel aƒü IP\'si ile test edebilirsiniz'}`
            };
        }
        
        // Safari-specific constraints
        const constraints = {
            video: isSafari ? {
                facingMode: isMobile ? 'user' : 'environment',
                width: { ideal: isMobile ? 640 : 1280, max: 1920 },
                height: { ideal: isMobile ? 480 : 720, max: 1080 },
                frameRate: { ideal: 30, max: 30 }
            } : (isMobile ? { 
                facingMode: 'user',
                width: { ideal: 640 },
                height: { ideal: 480 }
            } : true),
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 44100
            }
        };
        
        // Try modern API first with Safari-specific handling
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                stream.getTracks().forEach(track => track.stop());
                return { supported: true, granted: true };
            } catch (error) {
                // Safari sometimes needs simpler constraints
                if (isSafari) {
                    try {
                        const simpleConstraints = { video: true, audio: true };
                        const stream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
                        stream.getTracks().forEach(track => track.stop());
                        return { supported: true, granted: true };
                    } catch (simpleError) {
                        return {
                            supported: true,
                            granted: false,
                            error: simpleError.name,
                            message: getSafariErrorMessage(simpleError.name, isIOS)
                        };
                    }
                } else {
                    return {
                        supported: true,
                        granted: false,
                        error: error.name,
                        message: getErrorMessage(error.name, isMobile)
                    };
                }
            }
        }
        
        // Fallback for older browsers with Promise wrapper
        return new Promise((resolve) => {
            const getUserMedia = navigator.getUserMedia || 
                               navigator.webkitGetUserMedia || 
                               navigator.mozGetUserMedia ||
                               navigator.msGetUserMedia;
            
            if (!getUserMedia) {
                resolve({
                    supported: false,
                    message: 'getUserMedia desteklenmiyor'
                });
                return;
            }
            
            getUserMedia.call(navigator, constraints,
                (stream) => {
                    stream.getTracks().forEach(track => track.stop());
                    resolve({ supported: true, granted: true });
                },
                (error) => {
                    resolve({ 
                        supported: true, 
                        granted: false, 
                        error: error.name,
                        message: isSafari ? getSafariErrorMessage(error.name, isIOS) : getErrorMessage(error.name, isMobile)
                    });
                }
            );
        });
        
    } catch (error) {
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        return {
            supported: true,
            granted: false,
            error: error.name,
            message: isSafari ? getSafariErrorMessage(error.name, isIOS) : getErrorMessage(error.name, false)
        };
    }
}

// Safari-specific error messages
function getSafariErrorMessage(errorName, isIOS) {
    const deviceInfo = isIOS ? 'iOS Safari' : 'Safari';
    
    switch (errorName) {
        case 'NotAllowedError':
            return `${deviceInfo} izinleri reddedildi.\n\n` +
                   `${isIOS ? 
                     'üì± iPhone/iPad i√ßin:\n‚Ä¢ Safari ayarlarƒ±na gidin\n‚Ä¢ "Kamera" ve "Mikrofon" b√∂l√ºm√ºnden bu siteye izin verin\n‚Ä¢ Sayfa adresinin yanƒ±ndaki "AA" simgesine tƒ±klayƒ±n\n‚Ä¢ "Website Ayarlarƒ±" > "Kamera ve Mikrofon" > "ƒ∞zin Ver"\n‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin' :
                     'üñ•Ô∏è Mac Safari i√ßin:\n‚Ä¢ Adres √ßubuƒüundaki kamera simgesine tƒ±klayƒ±n\n‚Ä¢ "ƒ∞zin ver" se√ßeneƒüini se√ßin\n‚Ä¢ Safari > Tercihler > Web Siteleri > Kamera/Mikrofon\n‚Ä¢ Bu siteye izin verin'
                   }`;
        case 'NotFoundError':
            return `Kamera veya mikrofon bulunamadƒ±.\n\n‚Ä¢ ${isIOS ? 'iPhone/iPad' : 'Mac'} cihazƒ±nda kamera ve mikrofon olduƒüundan emin olun\n‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lmƒ±yor olabilir\n‚Ä¢ ${isIOS ? 'iOS ayarlarƒ±ndan kamera/mikrofon izinlerini kontrol edin' : 'Sistem tercihlerinden kamera/mikrofon izinlerini kontrol edin'}`;
        case 'NotReadableError':
            return `Kamera veya mikrofon kullanƒ±mda.\n\n‚Ä¢ Ba≈üka bir Safari sekmesi veya uygulama kullanƒ±yor olabilir\n‚Ä¢ ${isIOS ? 'Uygulamayƒ± kapatƒ±p tekrar a√ßƒ±n' : 'Safari\'yi yeniden ba≈ülatƒ±n'}\n‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin`;
        case 'OverconstrainedError':
            return `Kamera ayarlarƒ± desteklenmiyor.\n\n‚Ä¢ Safari\'nin kamera kƒ±sƒ±tlamalarƒ± nedeniyle\n‚Ä¢ Farklƒ± bir kamera kullanmayƒ± deneyin\n‚Ä¢ Basit video ayarlarƒ± deneniyor...`;
        case 'SecurityError':
            return `Safari g√ºvenlik hatasƒ±.\n\n‚Ä¢ HTTPS baƒülantƒ±sƒ± gerekli\n‚Ä¢ ${isIOS ? 'iOS 11.3+ gerekli' : 'macOS High Sierra+ gerekli'}\n‚Ä¢ Safari s√ºr√ºm√ºn√ºz√º g√ºncelleyin\n‚Ä¢ Yerel test i√ßin: http://192.168.x.x:9394`;
        case 'AbortError':
            return `ƒ∞≈ülem iptal edildi.\n\n‚Ä¢ Safari tarafƒ±ndan durduruldu\n‚Ä¢ Tekrar deneyiniz\n‚Ä¢ Sayfayƒ± yenileyin`;
        default:
            return `Safari hatasƒ±: ${errorName}\n\n‚Ä¢ Safari s√ºr√ºm√ºn√ºz√º g√ºncelleyin\n‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin\n‚Ä¢ ${isIOS ? 'iOS 11.3+' : 'macOS High Sierra+'} gerekli\n‚Ä¢ Chrome veya Firefox deneyebilirsiniz`;
    }
}

// Get user-friendly error message
function getErrorMessage(errorName, isMobile) {
    const deviceType = isMobile ? 'Mobil cihaz' : 'Tarayƒ±cƒ±';
    
    switch (errorName) {
        case 'NotAllowedError':
            return `${deviceType} izinleri reddedildi.\n\n` +
                   `${isMobile ? 
                     'üì± Mobil i√ßin:\n‚Ä¢ Tarayƒ±cƒ± ayarlarƒ±ndan siteye kamera/mikrofon izni verin\n‚Ä¢ Sayfa adresinin yanƒ±ndaki kilit simgesine tƒ±klayƒ±n\n‚Ä¢ "Kamera" ve "Mikrofon" se√ßeneklerini "ƒ∞zin ver" yapƒ±n' :
                     'üñ•Ô∏è Masa√ºst√º i√ßin:\n‚Ä¢ Adres √ßubuƒüundaki kamera simgesine tƒ±klayƒ±n\n‚Ä¢ "ƒ∞zin ver" se√ßeneƒüini se√ßin\n‚Ä¢ Sayfayƒ± yenileyin'
                   }`;
        case 'NotFoundError':
            return `Kamera veya mikrofon bulunamadƒ±.\n\n‚Ä¢ Cihazƒ±nƒ±zda kamera ve mikrofon olduƒüundan emin olun\n‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lmƒ±yor olabilir`;
        case 'NotReadableError':
            return `Kamera veya mikrofon kullanƒ±mda.\n\n‚Ä¢ Ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor olabilir\n‚Ä¢ Cihazƒ± yeniden ba≈ülatmayƒ± deneyin`;
        case 'OverconstrainedError':
            return `Kamera ayarlarƒ± desteklenmiyor.\n\n‚Ä¢ Farklƒ± bir kamera kullanmayƒ± deneyin`;
        case 'SecurityError':
            return `G√ºvenlik hatasƒ±.\n\n‚Ä¢ HTTPS baƒülantƒ±sƒ± gerekli olabilir\n‚Ä¢ Tarayƒ±cƒ± ayarlarƒ±nƒ± kontrol edin`;
        default:
            return `Bilinmeyen hata: ${errorName}\n\n‚Ä¢ Sayfayƒ± yenileyin ve tekrar deneyin\n‚Ä¢ Farklƒ± bir tarayƒ±cƒ± kullanmayƒ± deneyin`;
    }
}

// Update video call button based on permissions
async function updateVideoCallButton() {
    const permissions = await checkMediaPermissions();
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (!permissions.supported) {
        videoCallBtn.disabled = true;
        videoCallBtn.innerHTML = '<i class="fas fa-times"></i> Desteklenmiyor';
        videoCallBtn.title = permissions.message;
        
        // Add Safari-specific styling
        if (isSafari) {
            videoCallBtn.style.backgroundColor = '#ff6b6b';
            videoCallBtn.style.borderColor = '#ff6b6b';
        }
    } else if (!permissions.granted) {
        videoCallBtn.disabled = false;
        videoCallBtn.innerHTML = isSafari ? 
            `<i class="fas fa-video"></i> ${isIOS ? 'Safari ƒ∞zin Ver' : 'Safari G√∂r√º≈üme'}` :
            '<i class="fas fa-video"></i> ƒ∞zin Ver & G√∂r√ºnt√ºl√º G√∂r√º≈üme';
        videoCallBtn.title = permissions.message || 'Kamera ve mikrofon izni gerekli';
        
        // Add Safari-specific styling
        if (isSafari) {
            videoCallBtn.style.backgroundColor = '#007bff';
            videoCallBtn.style.borderColor = '#007bff';
            videoCallBtn.style.fontSize = '0.9em';
        }
    } else {
        videoCallBtn.disabled = false;
        videoCallBtn.innerHTML = isSafari ? 
            `<i class="fas fa-video"></i> ${isIOS ? 'iOS G√∂r√º≈üme' : 'Safari G√∂r√º≈üme'}` :
            '<i class="fas fa-video"></i> G√∂r√ºnt√ºl√º G√∂r√º≈üme';
        videoCallBtn.title = 'G√∂r√ºnt√ºl√º g√∂r√º≈üme ba≈ülat';
        
        // Add Safari success styling
        if (isSafari) {
            videoCallBtn.style.backgroundColor = '#28a745';
            videoCallBtn.style.borderColor = '#28a745';
        }
    }
    
    // Add Safari compatibility info
    if (isSafari && isIOS) {
        const safariInfo = document.createElement('small');
        safariInfo.style.display = 'block';
        safariInfo.style.color = '#6c757d';
        safariInfo.style.fontSize = '0.75em';
        safariInfo.style.marginTop = '5px';
        safariInfo.textContent = permissions.supported ? 
            (permissions.granted ? 'iOS Safari ‚úì' : 'iOS Safari - ƒ∞zin gerekli') :
            'iOS Safari desteklenmiyor';
        
        // Add info if not already exists
        const existingInfo = videoCallBtn.parentElement.querySelector('.safari-info');
        if (!existingInfo) {
            safariInfo.className = 'safari-info';
            videoCallBtn.parentElement.appendChild(safariInfo);
        }
    }
}

// Signaling polling
let signalingPollInterval;

function startSignalingPolling() {
    // Poll for signaling messages every 1 second
    signalingPollInterval = setInterval(async () => {
        if (sessionID) { // Always poll if sessionID exists, not just when call is active
            await pollSignalingMessages();
        }
    }, 1000);
}

function stopSignalingPolling() {
    if (signalingPollInterval) {
        clearInterval(signalingPollInterval);
        signalingPollInterval = null;
    }
}

async function pollSignalingMessages() {
    try {
        console.log('Polling signaling messages for sessionID:', sessionID);
        
        const response = await fetch(`/support/webrtc-signals/${sessionID}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Signaling poll response:', data);
        
        if (data.success && data.messages && data.messages.length > 0) {
            console.log('Processing signaling messages:', data.messages);
            for (const message of data.messages) {
                console.log('Handling signaling message:', message);
                await handleSignalingMessage(message);
            }
        }
    } catch (error) {
        console.error('Error polling signaling messages:', error);
        // Polling hatasƒ± durumunda kƒ±sa bir s√ºre bekle
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}
</script>
{{end}}